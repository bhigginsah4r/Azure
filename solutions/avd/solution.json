{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.6.18.56646",
      "templateHash": "11344312487398727714"
    }
  },
  "parameters": {
    "ArtifactsLocation": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/jamasten/Azure/master/solutions/avd/",
      "metadata": {
        "description": "The URL prefix for linked resources."
      }
    },
    "Availability": {
      "type": "string",
      "defaultValue": "None",
      "metadata": {
        "description": "Set the desired availability / SLA with a pooled host pool.  Choose \"None\" if deploying a personal host pool."
      },
      "allowedValues": [
        "AvailabilitySet",
        "AvailabilityZones",
        "None"
      ]
    },
    "AvdObjectId": {
      "type": "string",
      "metadata": {
        "description": "The Object ID for the Windows Virtual Desktop Enterprise Application in Azure AD.  The Object ID can found by selecting Microsoft Applications using the Application type filter in the Enterprise Applications blade of Azure AD."
      }
    },
    "CustomRdpProperty": {
      "type": "string",
      "defaultValue": "audiocapturemode:i:1;camerastoredirect:s:*;use multimon:i:0;drivestoredirect:s:;",
      "metadata": {
        "description": "Input RDP properties to add or remove RDP functionality on the AVD host pool. Settings reference: https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/rdp-files?context=/azure/virtual-desktop/context/context"
      }
    },
    "DiskEncryption": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable BitLocker encrytion on the AVD session hosts and management VM."
      }
    },
    "DiskSku": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "metadata": {
        "description": "The storage SKU for the AVD session host disks.  Production deployments should use Premium_LRS."
      },
      "allowedValues": [
        "Standard_LRS",
        "StandardSSD_LRS",
        "Premium_LRS"
      ]
    },
    "DisaStigCompliance": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Deploys an Automation Account and uses State Configuration to deploy and monitor DSC compliance.  PowerSTIG is used for the STIG configurations that adhere to DISAs STIG compliance."
      }
    },
    "DomainJoinPassword": {
      "type": "secureString",
      "metadata": {
        "description": "The password of the privileged account to domain join the AVD session hosts to your domain"
      }
    },
    "DomainJoinUserPrincipalName": {
      "type": "string",
      "metadata": {
        "description": "The UPN of the privileged account to domain join the AVD session hosts to your domain. This should be an account the resides within the domain you are joining."
      }
    },
    "DomainName": {
      "type": "string",
      "defaultValue": "jasonmasten.com",
      "metadata": {
        "description": "The name of the domain that provides ADDS to the AVD session hosts and is synchronized with Azure AD"
      }
    },
    "DomainServices": {
      "type": "string",
      "defaultValue": "AzureActiveDirectory",
      "metadata": {
        "description": "The service providing domain services for Azure Virtual Desktop.  This is needed to determine the proper solution to domain join the Azure Storage Account."
      },
      "allowedValues": [
        "ActiveDirectory",
        "AzureActiveDirectory",
        "None",
        "NoneWithIntune"
      ]
    },
    "DrainMode": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable drain mode on sessions hosts during deployment to prevent users from accessing the session hosts."
      }
    },
    "Environment": {
      "type": "string",
      "defaultValue": "d",
      "metadata": {
        "description": "The target environment for the solution."
      },
      "allowedValues": [
        "d",
        "p",
        "s",
        "t"
      ]
    },
    "EphemeralOsDisk": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Choose whether the session host uses an ephemeral disk for the operating system.  Be sure to select a VM SKU that offers a temporary disk that meets your image requirements. Reference: https://docs.microsoft.com/en-us/azure/virtual-machines/ephemeral-os-disks"
      }
    },
    "HostPoolType": {
      "type": "string",
      "defaultValue": "Pooled DepthFirst",
      "metadata": {
        "description": "These options specify the host pool type and depending on the type provides the load balancing options and assignment types."
      },
      "allowedValues": [
        "Pooled DepthFirst",
        "Pooled BreadthFirst",
        "Personal Automatic",
        "Personal Direct"
      ]
    },
    "HybridUseBenefit": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Choose whether to enable the Hybrid Use Benefit on the DNS forwarder to support Private Endpoints.  Leave the default value if you are not deploying an Azure Storage Account with a Private Endpoint."
      }
    },
    "Identifier": {
      "type": "string",
      "defaultValue": "avd",
      "metadata": {
        "description": "The unique identifier between each business unit or project supporting AVD in your tenant. This is the unique naming component between each AVD stamp."
      },
      "maxLength": 3
    },
    "ImageOffer": {
      "type": "string",
      "defaultValue": "office-365",
      "metadata": {
        "description": "Offer for the virtual machine image"
      }
    },
    "ImagePublisher": {
      "type": "string",
      "defaultValue": "MicrosoftWindowsDesktop",
      "metadata": {
        "description": "Publisher for the virtual machine image"
      }
    },
    "ImageSku": {
      "type": "string",
      "defaultValue": "21h1-evd-o365pp",
      "metadata": {
        "description": "SKU for the virtual machine image"
      }
    },
    "ImageVersion": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Version for the virtual machine image"
      }
    },
    "KerberosEncryption": {
      "type": "string",
      "defaultValue": "RC4",
      "metadata": {
        "description": "The Active Directory computer object Kerberos encryption type for the Azure Storage Account or Azure NetApp Files Account."
      },
      "allowedValues": [
        "AES256",
        "RC4"
      ]
    },
    "Location": {
      "type": "string",
      "defaultValue": "[deployment().location]"
    },
    "LogAnalyticsWorkspaceRetention": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "The retention for the Log Analytics Workspace to setup the AVD Monitoring solution"
      },
      "minValue": 30,
      "maxValue": 730
    },
    "LogAnalyticsWorkspaceSku": {
      "type": "string",
      "defaultValue": "PerGB2018",
      "metadata": {
        "description": "The SKU for the Log Analytics Workspace to setup the AVD Monitoring solution"
      },
      "allowedValues": [
        "Free",
        "Standard",
        "Premium",
        "PerNode",
        "PerGB2018",
        "Standalone",
        "CapacityReservation"
      ]
    },
    "MaxSessionLimit": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "The maximum number of sessions per AVD session host."
      }
    },
    "Monitoring": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploys the required monitoring resources to enable AVD Insights."
      }
    },
    "OuPath": {
      "type": "string",
      "metadata": {
        "description": "The distinguished name for the target Organization Unit in Active Directory Domain Services."
      }
    },
    "RdpShortPath": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enables the RDP Short Path feature: https://docs.microsoft.com/en-us/azure/virtual-desktop/shortpath"
      }
    },
    "RecoveryServices": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable backups to an Azure Recovery Services vault.  For a pooled host pool this will enable backups on the Azure file share.  For a personal host pool this will enable backups on the AVD sessions hosts."
      }
    },
    "ScalingBeginPeakTime": {
      "type": "string",
      "defaultValue": "9:00",
      "metadata": {
        "description": "Time when session hosts will scale up and continue to stay on to support peak demand; Format 24 hours e.g. 9:00 for 9am"
      }
    },
    "ScalingEndPeakTime": {
      "type": "string",
      "defaultValue": "17:00",
      "metadata": {
        "description": "Time when session hosts will scale down and stay off to support low demand; Format 24 hours e.g. 17:00 for 5pm"
      }
    },
    "ScalingLimitSecondsToForceLogOffUser": {
      "type": "string",
      "defaultValue": "0",
      "metadata": {
        "description": "The number of seconds to wait before automatically signing out users. If set to 0 any session host that has user sessions will be left untouched"
      }
    },
    "ScalingMinimumNumberOfRdsh": {
      "type": "string",
      "defaultValue": "0",
      "metadata": {
        "description": "The minimum number of session host VMs to keep running during off-peak hours. The scaling tool will not work if all virtual machines are turned off and the Start VM On Connect solution is not enabled."
      }
    },
    "ScalingSessionThresholdPerCPU": {
      "type": "string",
      "defaultValue": "1",
      "metadata": {
        "description": "The maximum number of sessions per CPU that will be used as a threshold to determine when new session host VMs need to be started during peak hours"
      }
    },
    "ScalingTimeDifference": {
      "type": "string",
      "defaultValue": "-5:00",
      "metadata": {
        "description": "Time zone off set for host pool location; Format 24 hours e.g. -4:00 for Eastern Daylight Time"
      }
    },
    "ScreenCaptureProtection": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Determines whether the Screen Capture Protection feature is enabled.  As of 9/17/21 this is only supported in Azure Cloud. https://docs.microsoft.com/en-us/azure/virtual-desktop/screen-capture-protection"
      }
    },
    "SasToken": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The SAS Token for the scripts if they are stored on an Azure Storage Account."
      }
    },
    "SecurityPrincipalObjectIds": {
      "type": "array",
      "metadata": {
        "description": "An array of Object IDs for the Security Principals to assign to the AVD Application Group and FSLogix Storage."
      }
    },
    "SecurityPrincipalNames": {
      "type": "array",
      "metadata": {
        "description": "The name for the Security Principal to assign NTFS permissions on the Azure File Share to support Fslogix.  Any value can be input in this field if performing a deployment update or choosing a personal host pool."
      }
    },
    "SessionHostCount": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "The number of session hosts to deploy in the host pool.  The default values will allow you deploy 250 VMs using 4 nested deployments.  These integers may be modified to create a smaller deployment in a shard."
      }
    },
    "SessionHostIndex": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "The session host number to begin with for the deployment. This is important when adding virtual machines to ensure the names do not conflict."
      }
    },
    "StampIndex": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "The stamp index specifies the AVD stamp within an Azure environment."
      }
    },
    "StartVmOnConnect": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Determines whether the Start VM On Connect feature is enabled. https://docs.microsoft.com/en-us/azure/virtual-desktop/start-virtual-machine-connect"
      }
    },
    "StorageCount": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "The Storage Count allows the deployment of one or more storage resources within an AVD stamp to shard for extra capacity. https://docs.microsoft.com/en-us/azure/architecture/patterns/sharding"
      },
      "minValue": 1
    },
    "StorageIndex": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "The Storage Index allows the deployment of one or more storage resources within an AVD stamp to shard for extra capacity. https://docs.microsoft.com/en-us/azure/architecture/patterns/sharding"
      }
    },
    "Subnet": {
      "type": "string",
      "defaultValue": "Clients",
      "metadata": {
        "description": "The subnet for the AVD session hosts."
      }
    },
    "Tags": {
      "type": "object",
      "defaultValue": {
        "Owner": "Jason Masten",
        "Purpose": "POC",
        "Environment": "Development"
      },
      "metadata": {
        "description": "Key / value pairs of metadata for the Azure resources."
      }
    },
    "Timestamp": {
      "type": "string",
      "defaultValue": "[utcNow('yyyyMMddhhmmss')]"
    },
    "ValidationEnvironment": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "The value determines whether the hostpool should receive early AVD updates for testing."
      }
    },
    "VirtualNetwork": {
      "type": "string",
      "defaultValue": "vnet-shd-net-d-eu",
      "metadata": {
        "description": "Virtual network for the AVD sessions hosts"
      }
    },
    "VirtualNetworkResourceGroup": {
      "type": "string",
      "defaultValue": "rg-shd-net-d-eu",
      "metadata": {
        "description": "Virtual network resource group for the AVD sessions hosts"
      }
    },
    "VmPassword": {
      "type": "secureString",
      "metadata": {
        "description": "Local administrator password for the AVD session hosts"
      }
    },
    "VmSize": {
      "type": "string",
      "defaultValue": "Standard_D4s_v4",
      "metadata": {
        "description": "The VM SKU for the AVD session hosts."
      }
    },
    "VmUsername": {
      "type": "string",
      "metadata": {
        "description": "The Local Administrator Username for the Session Hosts"
      }
    }
  },
  "variables": {
    "MaxResourcesPerTemplateDeployment": 79,
    "DivisionValue": "[div(parameters('SessionHostCount'), variables('MaxResourcesPerTemplateDeployment'))]",
    "DivisionRemainderValue": "[mod(parameters('SessionHostCount'), variables('MaxResourcesPerTemplateDeployment'))]",
    "SessionHostBatchCount": "[if(greater(variables('DivisionRemainderValue'), 0), add(variables('DivisionValue'), 1), variables('DivisionValue'))]",
    "MaxAvSetCount": 200,
    "DivisionAvSetValue": "[div(parameters('SessionHostCount'), variables('MaxAvSetCount'))]",
    "DivisionAvSetRemainderValue": "[mod(parameters('SessionHostCount'), variables('MaxAvSetCount'))]",
    "AvailabilitySetCount": "[if(greater(variables('DivisionAvSetRemainderValue'), 0), add(variables('DivisionAvSetValue'), 1), variables('DivisionAvSetValue'))]",
    "AppGroupName": "[format('dag-{0}', variables('NamingStandard'))]",
    "AvailabilitySetPrefix": "[format('as-{0}', variables('NamingStandard'))]",
    "AutomationAccountName": "[format('aa-{0}', variables('NamingStandard'))]",
    "ConfigurationName": "Windows10",
    "ConfigurationsUri": "[format('{0}configurations/', parameters('ArtifactsLocation'))]",
    "FileShareNames": {
      "ProfileContainer": [
        "profilecontainers"
      ],
      "ProfileOfficeContainer": [
        "officecontainers",
        "profilecontainers"
      ],
      "CloudCache": [
        "cloudcache"
      ]
    },
    "FileShares": "[variables('FileShareNames')[parameters('FslogixSolution')]]",
    "Fslogix": "[if(or(equals(parameters('FslogixStorage'), 'None'), contains(parameters('DomainServices'), 'None')), false(), true())]",
    "HostPoolName": "[format('hp-{0}', variables('NamingStandard'))]",
    "KeyVaultName": "[format('kv-{0}', variables('NamingStandard'))]",
    "LocationShortName": "[variables('LocationShortNames')[parameters('Location')]]",
    "LocationShortNames": {
      "australiacentral": "ac",
      "australiacentral2": "ac2",
      "australiaeast": "ae",
      "australiasoutheast": "as",
      "brazilsouth": "bs2",
      "brazilsoutheast": "bs",
      "canadacentral": "cc",
      "canadaeast": "ce",
      "centralindia": "ci",
      "centralus": "cu",
      "eastasia": "ea",
      "eastus": "eu",
      "eastus2": "eu2",
      "francecentral": "fc",
      "francesouth": "fs",
      "germanynorth": "gn",
      "germanywestcentral": "gwc",
      "japaneast": "je",
      "japanwest": "jw",
      "jioindiacentral": "jic",
      "jioindiawest": "jiw",
      "koreacentral": "kc",
      "koreasouth": "ks",
      "northcentralus": "ncu",
      "northeurope": "ne",
      "norwayeast": "ne2",
      "norwaywest": "nw",
      "southafricanorth": "san",
      "southafricawest": "saw",
      "southcentralus": "scu",
      "southeastasia": "sa",
      "southindia": "si",
      "swedencentral": "sc",
      "switzerlandnorth": "sn",
      "switzerlandwest": "sw",
      "uaecentral": "uc",
      "uaenorth": "un",
      "uksouth": "us",
      "ukwest": "uw",
      "usdodcentral": "uc",
      "usdodeast": "ue",
      "usgovarizona": "az",
      "usgoviowa": "ia",
      "usgovtexas": "tx",
      "usgovvirginia": "va",
      "westcentralus": "wcu",
      "westeurope": "we",
      "westindia": "wi",
      "westus": "wu",
      "westus2": "wu2",
      "westus3": "wu3"
    },
    "LogAnalyticsWorkspaceName": "[format('law-{0}', variables('NamingStandard'))]",
    "LogicAppPrefix": "[format('la-{0}', variables('NamingStandard'))]",
    "ManagedIdentityName": "[format('uami-{0}', variables('NamingStandard'))]",
    "ManagementVmName": "[format('{0}mgt', variables('VmName'))]",
    "NamingStandard": "[format('{0}-{1}-{2}-{3}', parameters('Identifier'), parameters('Environment'), variables('LocationShortName'), variables('StampIndexFull'))]",
    "NetAppAccountName": "[format('naa-{0}', variables('NamingStandard'))]",
    "NetAppCapacityPoolName": "[format('nacp-{0}', variables('NamingStandard'))]",
    "Netbios": "[split(parameters('DomainName'), '.')[0]]",
    "NetworkSecurityGroupName": "[format('nsg-{0}', variables('NamingStandard'))]",
    "PooledHostPool": "[if(equals(split(parameters('HostPoolType'), ' ')[0], 'Pooled'), true(), false())]",
    "PrivateDnsZoneName": "[format('privatelink.file.{0}', variables('StorageSuffix'))]",
    "PrivateEndpoint": "[if(contains(parameters('FslogixStorage'), 'PrivateEndpoint'), true(), false())]",
    "RecoveryServicesVaultName": "[format('rsv-{0}', variables('NamingStandard'))]",
    "ResourceGroups": [
      "[format('rg-{0}-deployment', variables('NamingStandard'))]",
      "[format('rg-{0}-hosts', variables('NamingStandard'))]",
      "[format('rg-{0}-management', variables('NamingStandard'))]",
      "[format('rg-{0}-storage', variables('NamingStandard'))]"
    ],
    "RoleDefinitionIds": {
      "contributor": "b24988ac-6180-42a0-ab88-20f7382dd24c",
      "desktopVirtualizationSessionHostOperator": "2ad6aaab-ead9-4eaa-8ac5-da422f562408",
      "desktopVirtualizationUser": "1d18fff3-a72a-46b5-b4a9-0b38a3cd7e63",
      "networkContributor": "4d97b98b-1d4f-4787-a291-c67834d212e7",
      "reader": "acdd72a7-3385-48ef-bd42-f606fba81ae7",
      "storageFileDataSMBShareContributor": "0c867c2a-1d8c-454a-a3db-ab2ea1bdc8bb",
      "virtualMachineUserLogin": "fb879df8-f326-4884-b1cf-06f3ad86be52"
    },
    "ScriptsUri": "[format('{0}scripts/', parameters('ArtifactsLocation'))]",
    "StampIndexFull": "[padLeft(parameters('StampIndex'), 2, '0')]",
    "StorageAccountPrefix": "[format('st{0}{1}{2}{3}', parameters('Identifier'), parameters('Environment'), variables('LocationShortName'), variables('StampIndexFull'))]",
    "StorageSolution": "[split(parameters('FslogixStorage'), ' ')[0]]",
    "StorageSku": "[if(equals(parameters('FslogixStorage'), 'None'), 'None', split(parameters('FslogixStorage'), ' ')[1])]",
    "StorageSuffix": "[environment().suffixes.storage]",
    "TimeZones": {
      "australiacentral": "Australian Eastern Standard Time",
      "australiacentral2": "Australian Eastern Standard Time",
      "australiaeast": "Australian Eastern Standard Time",
      "australiasoutheast": "Australian Eastern Standard Time",
      "brazilsouth": "Brasília Time",
      "brazilsoutheast": "Brasília Time",
      "canadacentral": "Eastern Standard Time",
      "canadaeast": "Eastern Standard Time",
      "centralindia": "India Standard Time",
      "centralus": "Central Standard Time",
      "chinaeast": "China Standard Time",
      "chinaeast2": "China Standard Time",
      "chinanorth": "China Standard Time",
      "chinanorth2": "China Standard Time",
      "eastasia": "Hong Kong Time",
      "eastus": "Eastern Standard Time",
      "eastus2": "Eastern Standard Time",
      "francecentral": "Central European Time",
      "francesouth": "Central European Time",
      "germanynorth": "Central European Time",
      "germanywestcentral": "Central European Time",
      "japaneast": "Japan Standard Time",
      "japanwest": "Japan Standard Time",
      "jioindiacentral": "India Standard Time",
      "jioindiawest": "India Standard Time",
      "koreacentral": "Korea Standard Time",
      "koreasouth": "Korea Standard Time",
      "northcentralus": "Central Standard Time",
      "northeurope": "Irish Standard Time",
      "norwayeast": "Central European Time",
      "norwaywest": "Central European Time",
      "southafricanorth": "South Africa Standard Time",
      "southafricawest": "South Africa Standard Time",
      "southcentralus": "Central Standard Time",
      "southindia": "India Standard Time",
      "southeastasia": "Singapore Time",
      "swedencentral": "Central European Time",
      "switzerlandnorth": "Central European Time",
      "switzerlandwest": "Central European Time",
      "uaecentral": "Gulf Standard Time",
      "uaenorth": "Gulf Standard Time",
      "uksouth": "Greenwich Mean Time",
      "ukwest": "Greenwich Mean Time",
      "usdodcentral": "Central Standard Time",
      "usdodeast": "Eastern Standard Time",
      "usgovarizona": "Mountain Standard Time",
      "usgoviowa": "Central Standard Time",
      "usgovtexas": "Central Standard Time",
      "usgovvirginia": "Eastern Standard Time",
      "westcentralus": "Mountain Standard Time",
      "westeurope": "Central European Time",
      "westindia": "India Standard Time",
      "westus": "Pacific Standard Time",
      "westus2": "Pacific Standard Time",
      "westus3": "Mountain Standard Time"
    },
    "VmName": "[format('vm{0}{1}{2}{3}', parameters('Identifier'), parameters('Environment'), variables('LocationShortName'), variables('StampIndexFull'))]",
    "VmTemplate": "[format('{{\"domain\":\"{0}\",\"galleryImageOffer\":\"{1}\",\"galleryImagePublisher\":\"{2}\",\"galleryImageSKU\":\"{3}\",\"imageType\":\"Gallery\",\"imageUri\":null,\"customImageId\":null,\"namePrefix\":\"{4}\",\"osDiskType\":\"{5}\",\"useManagedDisks\":true,\"vmSize\":{{\"id\":\"{6}\",\"cores\":null,\"ram\":null}},\"galleryItemId\":\"{7}.{8}{9}\"}}', parameters('DomainName'), parameters('ImageOffer'), parameters('ImagePublisher'), parameters('ImageSku'), variables('VmName'), parameters('DiskSku'), parameters('VmSize'), parameters('ImagePublisher'), parameters('ImageOffer'), parameters('ImageSku'))]",
    "WorkspaceName": "[format('ws-{0}', variables('NamingStandard'))]"
  },
  "resources": [
    {
      "copy": {
        "name": "resourceGroups",
        "count": "[length(range(0, length(variables('ResourceGroups'))))]"
      },
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2020-10-01",
      "name": "[variables('ResourceGroups')[range(0, length(variables('ResourceGroups')))[copyIndex()]]]",
      "location": "[parameters('Location')]",
      "tags": "[parameters('Tags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('ManagedIdentity_{0}', parameters('Timestamp'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "DrainMode": {
            "value": "[parameters('DrainMode')]"
          },
          "FslogixStorage": {
            "value": "[parameters('FslogixStorage')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "ManagedIdentityName": {
            "value": "[variables('ManagedIdentityName')]"
          },
          "ResourceGroups": {
            "value": "[variables('ResourceGroups')]"
          },
          "RoleDefinitionIds": {
            "value": "[variables('RoleDefinitionIds')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "VirtualNetworkResourceGroup": {
            "value": "[parameters('VirtualNetworkResourceGroup')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "2239238266289019320"
            }
          },
          "parameters": {
            "DrainMode": {
              "type": "bool"
            },
            "FslogixStorage": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "ManagedIdentityName": {
              "type": "string"
            },
            "ResourceGroups": {
              "type": "array"
            },
            "RoleDefinitionIds": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            },
            "VirtualNetworkResourceGroup": {
              "type": "string"
            }
          },
          "variables": {
            "RoleAssignments": [
              {
                "condition": "[parameters('DrainMode')]",
                "resourceGroup": "[parameters('ResourceGroups')[2]]",
                "roleDefinitionId": "[parameters('RoleDefinitionIds').desktopVirtualizationSessionHostOperator]"
              },
              {
                "condition": "[contains(parameters('FslogixStorage'), 'PrivateEndpoint')]",
                "resourceGroup": "[parameters('VirtualNetworkResourceGroup')]",
                "roleDefinitionId": "[parameters('RoleDefinitionIds').networkContributor]"
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleDefinitions",
              "apiVersion": "2018-01-01-preview",
              "name": "[guid('DeploymentScriptContributor', subscription().id)]",
              "properties": {
                "assignableScopes": [
                  "[subscription().id]"
                ],
                "roleName": "[format('DeploymentScriptContributor_{0}', subscription().subscriptionId)]",
                "description": "Allow Deployment Scripts to deploy required resources to run scripts.",
                "type": "customRole",
                "permissions": [
                  {
                    "actions": [
                      "Microsoft.Storage/storageAccounts/*",
                      "Microsoft.ContainerInstance/containerGroups/*",
                      "Microsoft.Resources/deployments/*",
                      "Microsoft.Resources/deploymentScripts/*",
                      "Microsoft.ManagedIdentity/userAssignedIdentities/assign/action"
                    ],
                    "notActions": []
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(parameters('ManagedIdentityName'), parameters('RoleDefinitionIds').reader, subscription().id)]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('RoleDefinitionIds').reader)]",
                "principalId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('UserAssignedManagedIdentity_{0}', parameters('Timestamp')))).outputs.principalId.value]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('UserAssignedManagedIdentity_{0}', parameters('Timestamp')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('UserAssignedManagedIdentity_{0}', parameters('Timestamp'))]",
              "resourceGroup": "[parameters('ResourceGroups')[0]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "ManagedIdentityName": {
                    "value": "[parameters('ManagedIdentityName')]"
                  },
                  "RoleDefinitionId": {
                    "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', guid('DeploymentScriptContributor', subscription().id))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.18.56646",
                      "templateHash": "2099432671293021930"
                    }
                  },
                  "parameters": {
                    "Location": {
                      "type": "string"
                    },
                    "ManagedIdentityName": {
                      "type": "string"
                    },
                    "RoleDefinitionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                      "apiVersion": "2018-11-30",
                      "name": "[parameters('ManagedIdentityName')]",
                      "location": "[parameters('Location')]"
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-04-01-preview",
                      "name": "[guid(parameters('ManagedIdentityName'), parameters('RoleDefinitionId'), resourceGroup().id)]",
                      "properties": {
                        "roleDefinitionId": "[parameters('RoleDefinitionId')]",
                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('ManagedIdentityName'))).principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('ManagedIdentityName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "principalId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('ManagedIdentityName'))).principalId]"
                    },
                    "resourceIdentifier": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('ManagedIdentityName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', guid('DeploymentScriptContributor', subscription().id))]"
              ]
            },
            {
              "copy": {
                "name": "roleAssignments",
                "count": "[length(range(0, length(variables('RoleAssignments'))))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('RoleAssignments_{0}_{1}', variables('RoleAssignments')[range(0, length(variables('RoleAssignments')))[copyIndex()]].resourceGroup, parameters('Timestamp'))]",
              "resourceGroup": "[variables('RoleAssignments')[range(0, length(variables('RoleAssignments')))[copyIndex()]].resourceGroup]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Condition": {
                    "value": "[variables('RoleAssignments')[range(0, length(variables('RoleAssignments')))[copyIndex()]].condition]"
                  },
                  "PrincipalId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('UserAssignedManagedIdentity_{0}', parameters('Timestamp')))).outputs.principalId.value]"
                  },
                  "RoleDefinitionId": {
                    "value": "[variables('RoleAssignments')[range(0, length(variables('RoleAssignments')))[copyIndex()]].roleDefinitionId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.18.56646",
                      "templateHash": "2214852005921199781"
                    }
                  },
                  "parameters": {
                    "Condition": {
                      "type": "bool"
                    },
                    "PrincipalId": {
                      "type": "string"
                    },
                    "RoleDefinitionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[parameters('Condition')]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-04-01-preview",
                      "name": "[guid(parameters('PrincipalId'), parameters('RoleDefinitionId'), resourceGroup().id)]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('RoleDefinitionId'))]",
                        "principalId": "[parameters('PrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('UserAssignedManagedIdentity_{0}', parameters('Timestamp')))]"
              ]
            }
          ],
          "outputs": {
            "principalId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('UserAssignedManagedIdentity_{0}', parameters('Timestamp')))).outputs.principalId.value]"
            },
            "resourceIdentifier": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('UserAssignedManagedIdentity_{0}', parameters('Timestamp')))).outputs.resourceIdentifier.value]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroups"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('Validation_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroups')[0]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Availability": {
            "value": "[parameters('Availability')]"
          },
          "DiskEncryption": {
            "value": "[parameters('DiskEncryption')]"
          },
          "DiskSku": {
            "value": "[parameters('DiskSku')]"
          },
          "DomainName": {
            "value": "[parameters('DomainName')]"
          },
          "DomainServices": {
            "value": "[parameters('DomainServices')]"
          },
          "EphemeralOsDisk": {
            "value": "[parameters('EphemeralOsDisk')]"
          },
          "FSLogixStorage": {
            "value": "[parameters('FslogixStorage')]"
          },
          "ImageSku": {
            "value": "[parameters('ImageSku')]"
          },
          "KerberosEncryption": {
            "value": "[parameters('KerberosEncryption')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "ManagedIdentityResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('ManagedIdentity_{0}', parameters('Timestamp')))).outputs.resourceIdentifier.value]"
          },
          "NamingStandard": {
            "value": "[variables('NamingStandard')]"
          },
          "SasToken": {
            "value": "[parameters('SasToken')]"
          },
          "ScriptsUri": {
            "value": "[variables('ScriptsUri')]"
          },
          "SecurityPrincipalIds": {
            "value": "[parameters('SecurityPrincipalObjectIds')]"
          },
          "SecurityPrincipalNames": {
            "value": "[parameters('SecurityPrincipalNames')]"
          },
          "SessionHostCount": {
            "value": "[parameters('SessionHostCount')]"
          },
          "SessionHostIndex": {
            "value": "[parameters('SessionHostIndex')]"
          },
          "StartVmOnConnect": {
            "value": "[parameters('StartVmOnConnect')]"
          },
          "StorageCount": {
            "value": "[parameters('StorageCount')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "VirtualNetwork": {
            "value": "[parameters('VirtualNetwork')]"
          },
          "VirtualNetworkResourceGroup": {
            "value": "[parameters('VirtualNetworkResourceGroup')]"
          },
          "VmSize": {
            "value": "[parameters('VmSize')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "15533680087352942918"
            }
          },
          "parameters": {
            "Availability": {
              "type": "string"
            },
            "DiskEncryption": {
              "type": "bool"
            },
            "DiskSku": {
              "type": "string"
            },
            "DomainName": {
              "type": "string"
            },
            "DomainServices": {
              "type": "string"
            },
            "EphemeralOsDisk": {
              "type": "bool"
            },
            "FSLogixStorage": {
              "type": "string"
            },
            "ImageSku": {
              "type": "string"
            },
            "KerberosEncryption": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "ManagedIdentityResourceId": {
              "type": "string"
            },
            "NamingStandard": {
              "type": "string"
            },
            "SasToken": {
              "type": "string"
            },
            "ScriptsUri": {
              "type": "string"
            },
            "SecurityPrincipalIds": {
              "type": "array"
            },
            "SecurityPrincipalNames": {
              "type": "array"
            },
            "SessionHostCount": {
              "type": "int"
            },
            "SessionHostIndex": {
              "type": "int"
            },
            "StartVmOnConnect": {
              "type": "bool"
            },
            "StorageCount": {
              "type": "int"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            },
            "VirtualNetwork": {
              "type": "string"
            },
            "VirtualNetworkResourceGroup": {
              "type": "string"
            },
            "VmSize": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "[format('ds-{0}-validation', parameters('NamingStandard'))]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "kind": "AzurePowerShell",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('ManagedIdentityResourceId'))]": {}
                }
              },
              "properties": {
                "forceUpdateTag": "[parameters('Timestamp')]",
                "azPowerShellVersion": "5.4",
                "arguments": "[format('-Availability {0} -DiskEncryption {1} -DiskSku {2} -DomainName {3} -DomainServices {4} -EphemeralOsDisk {5} -FSLogixStorage \\\"{6}\\\" -ImageSku {7} -KerberosEncryption {8} -Location {9} -SecurityPrincipalIds {10} -SecurityPrincipalNames {11} -SessionHostCount {12} -SessionHostIndex {13} -StartVmOnConnect {14} -StorageCount {15} -VmSize {16} -VnetName {17} -VnetResourceGroupName {18}', parameters('Availability'), parameters('DiskEncryption'), parameters('DiskSku'), parameters('DomainName'), parameters('DomainServices'), parameters('EphemeralOsDisk'), parameters('FSLogixStorage'), parameters('ImageSku'), parameters('KerberosEncryption'), parameters('Location'), parameters('SecurityPrincipalIds'), parameters('SecurityPrincipalNames'), parameters('SessionHostCount'), parameters('SessionHostIndex'), parameters('StartVmOnConnect'), parameters('StorageCount'), parameters('VmSize'), parameters('VirtualNetwork'), parameters('VirtualNetworkResourceGroup'))]",
                "primaryScriptUri": "[format('{0}Get-Validation.ps1{1}', parameters('ScriptsUri'), parameters('SasToken'))]",
                "timeout": "PT2H",
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "P1D"
              }
            }
          ],
          "outputs": {
            "acceleratedNetworking": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('ds-{0}-validation', parameters('NamingStandard')))).outputs.acceleratedNetworking]"
            },
            "anfActiveDirectory": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('ds-{0}-validation', parameters('NamingStandard')))).outputs.anfActiveDirectory]"
            },
            "anfDnsServers": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('ds-{0}-validation', parameters('NamingStandard')))).outputs.anfDnsServers]"
            },
            "anfSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('ds-{0}-validation', parameters('NamingStandard')))).outputs.anfSubnetId]"
            },
            "dnsForwarders": {
              "type": "array",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('ds-{0}-validation', parameters('NamingStandard')))).outputs.dnsForwarders]"
            },
            "dnsServerSize": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('ds-{0}-validation', parameters('NamingStandard')))).outputs.dnsServerSize]"
            },
            "ephemeralOsDisk": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('ds-{0}-validation', parameters('NamingStandard')))).outputs.ephemeralOsDisk]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('ManagedIdentity_{0}', parameters('Timestamp')))]",
        "resourceGroups"
      ]
    },
    {
      "condition": "[parameters('StartVmOnConnect')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('StartVmOnConnect_{0}', parameters('Timestamp'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "PrincipalId": {
            "value": "[parameters('AvdObjectId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "16172395441924815376"
            }
          },
          "parameters": {
            "PrincipalId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleDefinitions",
              "apiVersion": "2018-01-01-preview",
              "name": "[guid('StartVmOnConnect', subscription().id)]",
              "properties": {
                "assignableScopes": [
                  "[subscription().id]"
                ],
                "roleName": "[format('StartVmOnConnect_{0}', subscription().subscriptionId)]",
                "description": "Allow AVD session hosts to be started when needed.",
                "type": "customRole",
                "permissions": [
                  {
                    "actions": [
                      "Microsoft.Compute/virtualMachines/start/action",
                      "Microsoft.Compute/virtualMachines/read",
                      "Microsoft.Compute/virtualMachines/instanceView/read"
                    ],
                    "notActions": []
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2018-01-01-preview",
              "name": "[guid('Azure Virtual Desktop', 'StartVmOnConnect', subscription().id)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', guid('StartVmOnConnect', subscription().id))]",
                "principalId": "[parameters('PrincipalId')]"
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', guid('StartVmOnConnect', subscription().id))]"
              ]
            }
          ]
        }
      }
    },
    {
      "condition": "[or(variables('PooledHostPool'), parameters('DisaStigCompliance'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('AutomationAccount_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroups')[2]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AutomationAccountName": {
            "value": "[variables('AutomationAccountName')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "12453266114269160029"
            }
          },
          "parameters": {
            "AutomationAccountName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Automation/automationAccounts",
              "apiVersion": "2021-06-22",
              "name": "[parameters('AutomationAccountName')]",
              "location": "[parameters('Location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "sku": {
                  "name": "Free"
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "resourceGroups"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('HostPool_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroups')[2]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AppGroupName": {
            "value": "[variables('AppGroupName')]"
          },
          "CustomRdpProperty": {
            "value": "[parameters('CustomRdpProperty')]"
          },
          "DomainServices": {
            "value": "[parameters('DomainServices')]"
          },
          "HostPoolName": {
            "value": "[variables('HostPoolName')]"
          },
          "HostPoolType": {
            "value": "[parameters('HostPoolType')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "MaxSessionLimit": {
            "value": "[parameters('MaxSessionLimit')]"
          },
          "RoleDefinitionIds": {
            "value": "[variables('RoleDefinitionIds')]"
          },
          "SecurityPrincipalIds": {
            "value": "[parameters('SecurityPrincipalObjectIds')]"
          },
          "StartVmOnConnect": {
            "value": "[parameters('StartVmOnConnect')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "ValidationEnvironment": {
            "value": "[parameters('ValidationEnvironment')]"
          },
          "VmTemplate": {
            "value": "[variables('VmTemplate')]"
          },
          "WorkspaceName": {
            "value": "[variables('WorkspaceName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "10955339227929811282"
            }
          },
          "parameters": {
            "AppGroupName": {
              "type": "string"
            },
            "CustomRdpProperty": {
              "type": "string"
            },
            "DomainServices": {
              "type": "string"
            },
            "HostPoolName": {
              "type": "string"
            },
            "HostPoolType": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "MaxSessionLimit": {
              "type": "int"
            },
            "RoleDefinitionIds": {
              "type": "object"
            },
            "SecurityPrincipalIds": {
              "type": "array"
            },
            "StartVmOnConnect": {
              "type": "bool"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string",
              "defaultValue": "[utcNow('u')]"
            },
            "ValidationEnvironment": {
              "type": "bool"
            },
            "VmTemplate": {
              "type": "string"
            },
            "WorkspaceName": {
              "type": "string"
            }
          },
          "variables": {
            "CustomRdpProperty_Complete": "[if(contains(parameters('DomainServices'), 'None'), format('{0}targetisaadjoined:i:1', parameters('CustomRdpProperty')), parameters('CustomRdpProperty'))]"
          },
          "resources": [
            {
              "type": "Microsoft.DesktopVirtualization/hostPools",
              "apiVersion": "2021-03-09-preview",
              "name": "[parameters('HostPoolName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "hostPoolType": "[split(parameters('HostPoolType'), ' ')[0]]",
                "maxSessionLimit": "[parameters('MaxSessionLimit')]",
                "loadBalancerType": "[if(contains(parameters('HostPoolType'), 'Pooled'), split(parameters('HostPoolType'), ' ')[1], null())]",
                "validationEnvironment": "[parameters('ValidationEnvironment')]",
                "registrationInfo": {
                  "expirationTime": "[dateTimeAdd(parameters('Timestamp'), 'PT2H')]",
                  "registrationTokenOperation": "Update"
                },
                "preferredAppGroupType": "Desktop",
                "customRdpProperty": "[variables('CustomRdpProperty_Complete')]",
                "personalDesktopAssignmentType": "[if(contains(parameters('HostPoolType'), 'Personal'), split(parameters('HostPoolType'), ' ')[1], null())]",
                "startVMOnConnect": "[parameters('StartVmOnConnect')]",
                "vmTemplate": "[parameters('VmTemplate')]"
              }
            },
            {
              "type": "Microsoft.DesktopVirtualization/applicationGroups",
              "apiVersion": "2021-03-09-preview",
              "name": "[parameters('AppGroupName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "hostPoolArmPath": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))]",
                "applicationGroupType": "Desktop"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))]"
              ]
            },
            {
              "copy": {
                "name": "appGroupAssignment",
                "count": "[length(range(0, length(parameters('SecurityPrincipalIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2018-01-01-preview",
              "scope": "[format('Microsoft.DesktopVirtualization/applicationGroups/{0}', parameters('AppGroupName'))]",
              "name": "[guid(parameters('SecurityPrincipalIds')[range(0, length(parameters('SecurityPrincipalIds')))[copyIndex()]], parameters('RoleDefinitionIds').desktopVirtualizationUser, parameters('AppGroupName'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('RoleDefinitionIds').desktopVirtualizationUser)]",
                "principalId": "[parameters('SecurityPrincipalIds')[range(0, length(parameters('SecurityPrincipalIds')))[copyIndex()]]]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('AppGroupName'))]"
              ]
            },
            {
              "type": "Microsoft.DesktopVirtualization/workspaces",
              "apiVersion": "2021-03-09-preview",
              "name": "[parameters('WorkspaceName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "applicationGroupReferences": [
                  "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('AppGroupName'))]"
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('AppGroupName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "resourceGroups"
      ]
    },
    {
      "condition": "[parameters('Monitoring')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('Monitoring_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroups')[2]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AutomationAccountName": {
            "value": "[variables('AutomationAccountName')]"
          },
          "HostPoolName": {
            "value": "[variables('HostPoolName')]"
          },
          "LogAnalyticsWorkspaceName": {
            "value": "[variables('LogAnalyticsWorkspaceName')]"
          },
          "LogAnalyticsWorkspaceRetention": {
            "value": "[parameters('LogAnalyticsWorkspaceRetention')]"
          },
          "LogAnalyticsWorkspaceSku": {
            "value": "[parameters('LogAnalyticsWorkspaceSku')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "PooledHostPool": {
            "value": "[variables('PooledHostPool')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "WorkspaceName": {
            "value": "[variables('WorkspaceName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "2487077078142829699"
            }
          },
          "parameters": {
            "AutomationAccountName": {
              "type": "string"
            },
            "HostPoolName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "LogAnalyticsWorkspaceName": {
              "type": "string"
            },
            "LogAnalyticsWorkspaceRetention": {
              "type": "int"
            },
            "LogAnalyticsWorkspaceSku": {
              "type": "string"
            },
            "PooledHostPool": {
              "type": "bool"
            },
            "Tags": {
              "type": "object"
            },
            "WorkspaceName": {
              "type": "string"
            }
          },
          "variables": {
            "HostPoolLogs": [
              {
                "category": "Checkpoint",
                "enabled": true
              },
              {
                "category": "Error",
                "enabled": true
              },
              {
                "category": "Management",
                "enabled": true
              },
              {
                "category": "Connection",
                "enabled": true
              },
              {
                "category": "HostRegistration",
                "enabled": true
              },
              {
                "category": "AgentHealthStatus",
                "enabled": true
              }
            ],
            "NetworkData": [
              {
                "category": "NetworkData",
                "enabled": true
              }
            ],
            "WindowsEvents": [
              {
                "name": "Microsoft-FSLogix-Apps/Operational",
                "types": [
                  {
                    "eventType": "Error"
                  },
                  {
                    "eventType": "Warning"
                  },
                  {
                    "eventType": "Information"
                  }
                ]
              },
              {
                "name": "Microsoft-Windows-TerminalServices-LocalSessionManager/Operational",
                "types": [
                  {
                    "eventType": "Error"
                  },
                  {
                    "eventType": "Warning"
                  },
                  {
                    "eventType": "Information"
                  }
                ]
              },
              {
                "name": "System",
                "types": [
                  {
                    "eventType": "Error"
                  },
                  {
                    "eventType": "Warning"
                  }
                ]
              },
              {
                "name": "Microsoft-Windows-TerminalServices-RemoteConnectionManager/Admin",
                "types": [
                  {
                    "eventType": "Error"
                  },
                  {
                    "eventType": "Warning"
                  },
                  {
                    "eventType": "Information"
                  }
                ]
              },
              {
                "name": "Microsoft-FSLogix-Apps/Admin",
                "types": [
                  {
                    "eventType": "Error"
                  },
                  {
                    "eventType": "Warning"
                  },
                  {
                    "eventType": "Information"
                  }
                ]
              },
              {
                "name": "Application",
                "types": [
                  {
                    "eventType": "Error"
                  },
                  {
                    "eventType": "Warning"
                  }
                ]
              }
            ],
            "WindowsPerformanceCounters": [
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Disk Transfers/sec"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Current Disk Queue Length"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Disk Reads/sec"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "% Free Space"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk sec/Read"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Disk Writes/sec"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk sec/Write"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Free Megabytes"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "C:",
                "intervalSeconds": 60,
                "counterName": "% Free Space"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "C:",
                "intervalSeconds": 30,
                "counterName": "Avg. Disk Queue Length"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "C:",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk sec/Transfer"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "C:",
                "intervalSeconds": 30,
                "counterName": "Current Disk Queue Length"
              },
              {
                "objectName": "Memory",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "% Committed Bytes In Use"
              },
              {
                "objectName": "Memory",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Available MBytes"
              },
              {
                "objectName": "Memory",
                "instanceName": "*",
                "intervalSeconds": 30,
                "counterName": "Available Mbytes"
              },
              {
                "objectName": "Memory",
                "instanceName": "*",
                "intervalSeconds": 30,
                "counterName": "Page Faults/sec"
              },
              {
                "objectName": "Memory",
                "instanceName": "*",
                "intervalSeconds": 30,
                "counterName": "Pages/sec"
              },
              {
                "objectName": "Network Adapter",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Bytes Sent/sec"
              },
              {
                "objectName": "Network Adapter",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Bytes Received/sec"
              },
              {
                "objectName": "Network Interface",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Bytes Total/sec"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk Bytes/Transfer"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk Bytes/Read"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk sec/Write"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk sec/Read"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk Bytes/Write"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk sec/Transfer"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 30,
                "counterName": "Avg. Disk Queue Length"
              },
              {
                "objectName": "Process",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "IO Write Operations/sec"
              },
              {
                "objectName": "Process",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "IO Read Operations/sec"
              },
              {
                "objectName": "Process",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Thread Count"
              },
              {
                "objectName": "Process",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "% User Time"
              },
              {
                "objectName": "Process",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Working Set"
              },
              {
                "objectName": "Process",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "% Processor Time"
              },
              {
                "objectName": "Processor",
                "instanceName": "_Total",
                "intervalSeconds": 60,
                "counterName": "% Processor Time"
              },
              {
                "objectName": "Processor Information",
                "instanceName": "_Total",
                "intervalSeconds": 30,
                "counterName": "% Processor Time"
              },
              {
                "objectName": "RemoteFX Graphics",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Frames Skipped/Second - Insufficient Server Resources"
              },
              {
                "objectName": "RemoteFX Graphics",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Average Encoding Time"
              },
              {
                "objectName": "RemoteFX Graphics",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Frames Skipped/Second - Insufficient Client Resources"
              },
              {
                "objectName": "RemoteFX Graphics",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Frames Skipped/Second - Insufficient Network Resources"
              },
              {
                "objectName": "RemoteFX Network",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Current UDP Bandwidth"
              },
              {
                "objectName": "RemoteFX Network",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Current TCP Bandwidth"
              },
              {
                "objectName": "RemoteFX Network",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Current TCP RTT"
              },
              {
                "objectName": "RemoteFX Network",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Current UDP RTT"
              },
              {
                "objectName": "System",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Processor Queue Length"
              },
              {
                "objectName": "Terminal Services",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Inactive Sessions"
              },
              {
                "objectName": "Terminal Services",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Total Sessions"
              },
              {
                "objectName": "Terminal Services",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Active Sessions"
              },
              {
                "objectName": "Terminal Services Session",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "% Processor Time"
              },
              {
                "objectName": "User Input Delay per Process",
                "instanceName": "*",
                "intervalSeconds": 30,
                "counterName": "Max Input Delay"
              },
              {
                "objectName": "User Input Delay per Session",
                "instanceName": "*",
                "intervalSeconds": 30,
                "counterName": "Max Input Delay"
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2021-06-01",
              "name": "[parameters('LogAnalyticsWorkspaceName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "sku": {
                  "name": "[parameters('LogAnalyticsWorkspaceSku')]"
                },
                "retentionInDays": "[parameters('LogAnalyticsWorkspaceRetention')]",
                "workspaceCapping": {
                  "dailyQuotaGb": -1
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            },
            {
              "copy": {
                "name": "windowsEvents",
                "count": "[length(variables('WindowsEvents'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.OperationalInsights/workspaces/dataSources",
              "apiVersion": "2020-08-01",
              "name": "[format('{0}/WindowsEvent{1}', parameters('LogAnalyticsWorkspaceName'), copyIndex())]",
              "tags": "[parameters('Tags')]",
              "kind": "WindowsEvent",
              "properties": {
                "eventLogName": "[variables('WindowsEvents')[copyIndex()].name]",
                "eventTypes": "[variables('WindowsEvents')[copyIndex()].types]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName'))]"
              ]
            },
            {
              "copy": {
                "name": "windowsPerformanceCounters",
                "count": "[length(variables('WindowsPerformanceCounters'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.OperationalInsights/workspaces/dataSources",
              "apiVersion": "2020-08-01",
              "name": "[format('{0}/WindowsPerformanceCounter{1}', parameters('LogAnalyticsWorkspaceName'), copyIndex())]",
              "tags": "[parameters('Tags')]",
              "kind": "WindowsPerformanceCounter",
              "properties": {
                "objectName": "[variables('WindowsPerformanceCounters')[copyIndex()].objectName]",
                "instanceName": "[variables('WindowsPerformanceCounters')[copyIndex()].instanceName]",
                "intervalSeconds": "[variables('WindowsPerformanceCounters')[copyIndex()].intervalSeconds]",
                "counterName": "[variables('WindowsPerformanceCounters')[copyIndex()].counterName]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName'))]",
                "windowsEvents"
              ]
            },
            {
              "type": "Microsoft.DesktopVirtualization/workspaces/providers/diagnosticsettings",
              "apiVersion": "2017-05-01-preview",
              "name": "[format('{0}/Microsoft.Insights/diag-{1}', parameters('WorkspaceName'), parameters('WorkspaceName'))]",
              "properties": {
                "logs": [
                  {
                    "category": "Checkpoint",
                    "enabled": true
                  },
                  {
                    "category": "Error",
                    "enabled": true
                  },
                  {
                    "category": "Management",
                    "enabled": true
                  },
                  {
                    "category": "Feed",
                    "enabled": true
                  }
                ],
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName'))]"
              }
            },
            {
              "type": "Microsoft.DesktopVirtualization/hostPools/providers/diagnosticsettings",
              "apiVersion": "2017-05-01-preview",
              "name": "[format('{0}/Microsoft.Insights/diag-{1}', parameters('HostPoolName'), parameters('HostPoolName'))]",
              "properties": {
                "logs": "[if(equals(environment().name, 'AzureCloud'), union(variables('HostPoolLogs'), variables('NetworkData')), variables('HostPoolLogs'))]",
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName'))]"
              }
            },
            {
              "condition": "[parameters('PooledHostPool')]",
              "type": "Microsoft.Automation/automationAccounts/providers/diagnosticsettings",
              "apiVersion": "2017-05-01-preview",
              "name": "[format('{0}/Microsoft.Insights/diag-{1}', parameters('AutomationAccountName'), parameters('AutomationAccountName'))]",
              "properties": {
                "logs": [
                  {
                    "category": "JobLogs",
                    "enabled": true
                  },
                  {
                    "category": "JobStreams",
                    "enabled": true
                  }
                ],
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[2]), 'Microsoft.Resources/deployments', format('HostPool_{0}', parameters('Timestamp')))]",
        "resourceGroups"
      ]
    },
    {
      "condition": "[parameters('DiskEncryption')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('BitLocker_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroups')[2]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "DeploymentResourceGroup": {
            "value": "[variables('ResourceGroups')[0]]"
          },
          "KeyVaultName": {
            "value": "[variables('KeyVaultName')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "ManagedIdentityPrincipalId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('ManagedIdentity_{0}', parameters('Timestamp')))).outputs.principalId.value]"
          },
          "ManagedIdentityResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('ManagedIdentity_{0}', parameters('Timestamp')))).outputs.resourceIdentifier.value]"
          },
          "NamingStandard": {
            "value": "[variables('NamingStandard')]"
          },
          "SasToken": {
            "value": "[parameters('SasToken')]"
          },
          "ScriptsUri": {
            "value": "[variables('ScriptsUri')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "3530909959540836667"
            }
          },
          "parameters": {
            "DeploymentResourceGroup": {
              "type": "string"
            },
            "KeyVaultName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "ManagedIdentityPrincipalId": {
              "type": "string"
            },
            "ManagedIdentityResourceId": {
              "type": "string"
            },
            "NamingStandard": {
              "type": "string"
            },
            "SasToken": {
              "type": "secureString"
            },
            "ScriptsUri": {
              "type": "string"
            },
            "Timestamp": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2016-10-01",
              "name": "[parameters('KeyVaultName')]",
              "location": "[parameters('Location')]",
              "tags": {},
              "properties": {
                "tenantId": "[subscription().tenantId]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "accessPolicies": [
                  {
                    "tenantId": "[subscription().tenantId]",
                    "objectId": "[parameters('ManagedIdentityPrincipalId')]",
                    "permissions": {
                      "keys": [
                        "get",
                        "list",
                        "create"
                      ],
                      "secrets": []
                    }
                  }
                ],
                "enabledForDeployment": false,
                "enabledForTemplateDeployment": false,
                "enabledForDiskEncryption": true
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('DeploymentScript_{0}', parameters('Timestamp'))]",
              "resourceGroup": "[parameters('DeploymentResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "KeyVaultName": {
                    "value": "[parameters('KeyVaultName')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "ManagedIdentityResourceId": {
                    "value": "[parameters('ManagedIdentityResourceId')]"
                  },
                  "NamingStandard": {
                    "value": "[parameters('NamingStandard')]"
                  },
                  "SasToken": {
                    "value": "[parameters('SasToken')]"
                  },
                  "ScriptsUri": {
                    "value": "[parameters('ScriptsUri')]"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.18.56646",
                      "templateHash": "4601776957987619522"
                    }
                  },
                  "parameters": {
                    "KeyVaultName": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "ManagedIdentityResourceId": {
                      "type": "string"
                    },
                    "NamingStandard": {
                      "type": "string"
                    },
                    "SasToken": {
                      "type": "secureString"
                    },
                    "ScriptsUri": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2019-10-01-preview",
                      "name": "[format('ds-{0}-bitlockerKek', parameters('NamingStandard'))]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('ManagedIdentityResourceId'))]": {}
                        }
                      },
                      "location": "[parameters('Location')]",
                      "kind": "AzurePowerShell",
                      "tags": {},
                      "properties": {
                        "azPowerShellVersion": "5.4",
                        "cleanupPreference": "OnSuccess",
                        "primaryScriptUri": "[format('{0}New-AzureKeyEncryptionKey.ps1{1}', parameters('ScriptsUri'), parameters('SasToken'))]",
                        "arguments": "[format(' -KeyVault {0}', parameters('KeyVaultName'))]",
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "retentionInterval": "P1D",
                        "timeout": "PT30M"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('KeyVaultName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('ManagedIdentity_{0}', parameters('Timestamp')))]"
      ]
    },
    {
      "condition": "[parameters('DisaStigCompliance')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('STIG_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroups')[2]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AutomationAccountName": {
            "value": "[variables('AutomationAccountName')]"
          },
          "ConfigurationName": {
            "value": "[variables('ConfigurationName')]"
          },
          "ConfigurationsUri": {
            "value": "[variables('ConfigurationsUri')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "8652271499282772204"
            }
          },
          "parameters": {
            "AutomationAccountName": {
              "type": "string"
            },
            "ConfigurationName": {
              "type": "string"
            },
            "ConfigurationsUri": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "Timestamp": {
              "type": "string"
            }
          },
          "variables": {
            "Modules": [
              {
                "name": "AccessControlDSC",
                "uri": "https://www.powershellgallery.com/api/v2/package/AccessControlDSC/1.4.1"
              },
              {
                "name": "AuditPolicyDsc",
                "uri": "https://www.powershellgallery.com/api/v2/package/AuditPolicyDsc/1.4.0.0"
              },
              {
                "name": "AuditSystemDsc",
                "uri": "https://www.powershellgallery.com/api/v2/package/AuditSystemDsc/1.1.0"
              },
              {
                "name": "CertificateDsc",
                "uri": "https://www.powershellgallery.com/api/v2/package/CertificateDsc/5.0.0"
              },
              {
                "name": "ComputerManagementDsc",
                "uri": "https://www.powershellgallery.com/api/v2/package/ComputerManagementDsc/8.4.0"
              },
              {
                "name": "FileContentDsc",
                "uri": "https://www.powershellgallery.com/api/v2/package/FileContentDsc/1.3.0.151"
              },
              {
                "name": "GPRegistryPolicyDsc",
                "uri": "https://www.powershellgallery.com/api/v2/package/GPRegistryPolicyDsc/1.2.0"
              },
              {
                "name": "nx",
                "uri": "https://www.powershellgallery.com/api/v2/package/nx/1.0"
              },
              {
                "name": "PSDscResources",
                "uri": "https://www.powershellgallery.com/api/v2/package/PSDscResources/2.12.0.0"
              },
              {
                "name": "SecurityPolicyDsc",
                "uri": "https://www.powershellgallery.com/api/v2/package/SecurityPolicyDsc/2.10.0.0"
              },
              {
                "name": "SqlServerDsc",
                "uri": "https://www.powershellgallery.com/api/v2/package/SqlServerDsc/13.3.0"
              },
              {
                "name": "WindowsDefenderDsc",
                "uri": "https://www.powershellgallery.com/api/v2/package/WindowsDefenderDsc/2.1.0"
              },
              {
                "name": "xDnsServer",
                "uri": "https://www.powershellgallery.com/api/v2/package/xDnsServer/1.16.0.0"
              },
              {
                "name": "xWebAdministration",
                "uri": "https://www.powershellgallery.com/api/v2/package/xWebAdministration/3.2.0"
              },
              {
                "name": "PowerSTIG",
                "uri": "https://www.powershellgallery.com/api/v2/package/PowerSTIG/4.10.1"
              }
            ]
          },
          "resources": [
            {
              "copy": {
                "name": "modules",
                "count": "[length(variables('Modules'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.Automation/automationAccounts/modules",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}', parameters('AutomationAccountName'), variables('Modules')[copyIndex()].name)]",
              "location": "[parameters('Location')]",
              "properties": {
                "contentLink": {
                  "uri": "[variables('Modules')[copyIndex()].uri]"
                }
              }
            },
            {
              "type": "Microsoft.Automation/automationAccounts/configurations",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}', parameters('AutomationAccountName'), parameters('ConfigurationName'))]",
              "location": "[parameters('Location')]",
              "properties": {
                "source": {
                  "type": "uri",
                  "value": "[format('{0}Windows10.ps1', parameters('ConfigurationsUri'))]",
                  "version": "[parameters('Timestamp')]"
                },
                "parameters": {},
                "description": "Hardens the VM using the Azure STIG Template"
              },
              "dependsOn": [
                "modules"
              ]
            },
            {
              "type": "Microsoft.Automation/automationAccounts/compilationjobs",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}', parameters('AutomationAccountName'), guid(deployment().name))]",
              "location": "[parameters('Location')]",
              "properties": {
                "configuration": {
                  "name": "[parameters('ConfigurationName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts/configurations', split(format('{0}/{1}', parameters('AutomationAccountName'), parameters('ConfigurationName')), '/')[0], split(format('{0}/{1}', parameters('AutomationAccountName'), parameters('ConfigurationName')), '/')[1])]",
                "modules"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[2]), 'Microsoft.Resources/deployments', format('AutomationAccount_{0}', parameters('Timestamp')))]",
        "resourceGroups"
      ]
    },
    {
      "condition": "[variables('Fslogix')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('FSLogix_{0}', parameters('Timestamp'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "ActiveDirectoryConnection": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('Validation_{0}', parameters('Timestamp')))).outputs.anfActiveDirectory.value]"
          },
          "ConfigurationsUri": {
            "value": "[variables('ConfigurationsUri')]"
          },
          "DelegatedSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('Validation_{0}', parameters('Timestamp')))).outputs.anfSubnetId.value]"
          },
          "DiskEncryption": {
            "value": "[parameters('DiskEncryption')]"
          },
          "DnsServerForwarderIPAddresses": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('Validation_{0}', parameters('Timestamp')))).outputs.dnsForwarders.value]"
          },
          "DnsServers": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('Validation_{0}', parameters('Timestamp')))).outputs.anfDnsServers.value]"
          },
          "DnsServerSize": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('Validation_{0}', parameters('Timestamp')))).outputs.dnsServerSize.value]"
          },
          "DomainJoinPassword": {
            "value": "[parameters('DomainJoinPassword')]"
          },
          "DomainJoinUserPrincipalName": {
            "value": "[parameters('DomainJoinUserPrincipalName')]"
          },
          "DomainName": {
            "value": "[parameters('DomainName')]"
          },
          "DomainServices": {
            "value": "[parameters('DomainServices')]"
          },
          "Environment": {
            "value": "[parameters('Environment')]"
          },
          "FileShares": {
            "value": "[variables('FileShares')]"
          },
          "FslogixShareSizeInGB": {
            "value": "[parameters('FslogixShareSizeInGB')]"
          },
          "FslogixStorage": {
            "value": "[parameters('FslogixStorage')]"
          },
          "HostPoolName": {
            "value": "[variables('HostPoolName')]"
          },
          "HybridUseBenefit": {
            "value": "[parameters('HybridUseBenefit')]"
          },
          "Identifier": {
            "value": "[parameters('Identifier')]"
          },
          "KerberosEncryption": {
            "value": "[parameters('KerberosEncryption')]"
          },
          "KeyVaultName": {
            "value": "[variables('KeyVaultName')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "LocationShortName": {
            "value": "[variables('LocationShortName')]"
          },
          "ManagedIdentityResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('ManagedIdentity_{0}', parameters('Timestamp')))).outputs.resourceIdentifier.value]"
          },
          "ManagementVmName": {
            "value": "[variables('ManagementVmName')]"
          },
          "NamingStandard": {
            "value": "[variables('NamingStandard')]"
          },
          "NetAppAccountName": {
            "value": "[variables('NetAppAccountName')]"
          },
          "NetAppCapacityPoolName": {
            "value": "[variables('NetAppCapacityPoolName')]"
          },
          "Netbios": {
            "value": "[variables('Netbios')]"
          },
          "OuPath": {
            "value": "[parameters('OuPath')]"
          },
          "PrivateDnsZoneName": {
            "value": "[variables('PrivateDnsZoneName')]"
          },
          "PrivateEndpoint": {
            "value": "[variables('PrivateEndpoint')]"
          },
          "ResourceGroups": {
            "value": "[variables('ResourceGroups')]"
          },
          "RoleDefinitionIds": {
            "value": "[variables('RoleDefinitionIds')]"
          },
          "SasToken": {
            "value": "[parameters('SasToken')]"
          },
          "ScriptsUri": {
            "value": "[variables('ScriptsUri')]"
          },
          "SecurityPrincipalIds": {
            "value": "[parameters('SecurityPrincipalObjectIds')]"
          },
          "SecurityPrincipalNames": {
            "value": "[parameters('SecurityPrincipalNames')]"
          },
          "SmbServerLocation": {
            "value": "[variables('LocationShortName')]"
          },
          "StampIndexFull": {
            "value": "[variables('StampIndexFull')]"
          },
          "StorageAccountPrefix": {
            "value": "[variables('StorageAccountPrefix')]"
          },
          "StorageCount": {
            "value": "[parameters('StorageCount')]"
          },
          "StorageIndex": {
            "value": "[parameters('StorageIndex')]"
          },
          "StorageSku": {
            "value": "[variables('StorageSku')]"
          },
          "StorageSolution": {
            "value": "[variables('StorageSolution')]"
          },
          "StorageSuffix": {
            "value": "[variables('StorageSuffix')]"
          },
          "Subnet": {
            "value": "[parameters('Subnet')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "VirtualNetwork": {
            "value": "[parameters('VirtualNetwork')]"
          },
          "VirtualNetworkResourceGroup": {
            "value": "[parameters('VirtualNetworkResourceGroup')]"
          },
          "VmPassword": {
            "value": "[parameters('VmPassword')]"
          },
          "VmUsername": {
            "value": "[parameters('VmUsername')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "10415342650277218263"
            }
          },
          "parameters": {
            "ActiveDirectoryConnection": {
              "type": "string"
            },
            "ConfigurationsUri": {
              "type": "string"
            },
            "DelegatedSubnetId": {
              "type": "string"
            },
            "DiskEncryption": {
              "type": "bool"
            },
            "DnsServerForwarderIPAddresses": {
              "type": "array"
            },
            "DnsServers": {
              "type": "string"
            },
            "DnsServerSize": {
              "type": "string"
            },
            "DomainJoinPassword": {
              "type": "secureString"
            },
            "DomainJoinUserPrincipalName": {
              "type": "string"
            },
            "DomainName": {
              "type": "string"
            },
            "DomainServices": {
              "type": "string"
            },
            "Environment": {
              "type": "string"
            },
            "FileShares": {
              "type": "array"
            },
            "FslogixShareSizeInGB": {
              "type": "int"
            },
            "FslogixStorage": {
              "type": "string"
            },
            "HostPoolName": {
              "type": "string"
            },
            "HybridUseBenefit": {
              "type": "bool"
            },
            "Identifier": {
              "type": "string"
            },
            "KerberosEncryption": {
              "type": "string"
            },
            "KeyVaultName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "LocationShortName": {
              "type": "string"
            },
            "ManagedIdentityResourceId": {
              "type": "string"
            },
            "ManagementVmName": {
              "type": "string"
            },
            "NamingStandard": {
              "type": "string"
            },
            "NetAppAccountName": {
              "type": "string"
            },
            "NetAppCapacityPoolName": {
              "type": "string"
            },
            "Netbios": {
              "type": "string"
            },
            "OuPath": {
              "type": "string"
            },
            "PrivateDnsZoneName": {
              "type": "string"
            },
            "PrivateEndpoint": {
              "type": "bool"
            },
            "SasToken": {
              "type": "string"
            },
            "ScriptsUri": {
              "type": "string"
            },
            "SecurityPrincipalIds": {
              "type": "array"
            },
            "SecurityPrincipalNames": {
              "type": "array"
            },
            "SmbServerLocation": {
              "type": "string"
            },
            "StampIndexFull": {
              "type": "string"
            },
            "StorageAccountPrefix": {
              "type": "string"
            },
            "StorageCount": {
              "type": "int"
            },
            "StorageIndex": {
              "type": "int"
            },
            "StorageSku": {
              "type": "string"
            },
            "StorageSolution": {
              "type": "string"
            },
            "StorageSuffix": {
              "type": "string"
            },
            "Subnet": {
              "type": "string"
            },
            "ResourceGroups": {
              "type": "array"
            },
            "RoleDefinitionIds": {
              "type": "object"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            },
            "VirtualNetwork": {
              "type": "string"
            },
            "VirtualNetworkResourceGroup": {
              "type": "string"
            },
            "VmPassword": {
              "type": "secureString"
            },
            "VmUsername": {
              "type": "string"
            }
          },
          "resources": [
            {
              "condition": "[not(contains(parameters('DomainServices'), 'None'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('ManagementVirtualMachine_{0}', parameters('Timestamp'))]",
              "resourceGroup": "[parameters('ResourceGroups')[0]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "DiskEncryption": {
                    "value": "[parameters('DiskEncryption')]"
                  },
                  "DomainJoinPassword": {
                    "value": "[parameters('DomainJoinPassword')]"
                  },
                  "DomainJoinUserPrincipalName": {
                    "value": "[parameters('DomainJoinUserPrincipalName')]"
                  },
                  "DomainName": {
                    "value": "[parameters('DomainName')]"
                  },
                  "KeyVaultName": {
                    "value": "[parameters('KeyVaultName')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "ManagementVmName": {
                    "value": "[parameters('ManagementVmName')]"
                  },
                  "NamingStandard": {
                    "value": "[parameters('NamingStandard')]"
                  },
                  "ResourceGroups": {
                    "value": "[parameters('ResourceGroups')]"
                  },
                  "Subnet": {
                    "value": "[parameters('Subnet')]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "VirtualNetwork": {
                    "value": "[parameters('VirtualNetwork')]"
                  },
                  "VirtualNetworkResourceGroup": {
                    "value": "[parameters('VirtualNetworkResourceGroup')]"
                  },
                  "VmPassword": {
                    "value": "[parameters('VmPassword')]"
                  },
                  "VmUsername": {
                    "value": "[parameters('VmUsername')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.18.56646",
                      "templateHash": "14059912686551358202"
                    }
                  },
                  "parameters": {
                    "DiskEncryption": {
                      "type": "bool"
                    },
                    "DomainJoinPassword": {
                      "type": "secureString"
                    },
                    "DomainJoinUserPrincipalName": {
                      "type": "string"
                    },
                    "DomainName": {
                      "type": "string"
                    },
                    "KeyVaultName": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "ManagementVmName": {
                      "type": "string"
                    },
                    "NamingStandard": {
                      "type": "string"
                    },
                    "ResourceGroups": {
                      "type": "array"
                    },
                    "Subnet": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "VirtualNetwork": {
                      "type": "string"
                    },
                    "VirtualNetworkResourceGroup": {
                      "type": "string"
                    },
                    "VmPassword": {
                      "type": "secureString"
                    },
                    "VmUsername": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "DeploymentResourceGroup": "[parameters('ResourceGroups')[0]]",
                    "ManagementResourceGroup": "[parameters('ResourceGroups')[2]]",
                    "NicName": "[format('nic-{0}-mgt', parameters('NamingStandard'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2020-05-01",
                      "name": "[variables('NicName')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[resourceId(parameters('VirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('VirtualNetwork'), parameters('Subnet'))]"
                              },
                              "primary": true,
                              "privateIPAddressVersion": "IPv4"
                            }
                          }
                        ],
                        "enableAcceleratedNetworking": false,
                        "enableIPForwarding": false
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-11-01",
                      "name": "[parameters('ManagementVmName')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "Standard_B2s"
                        },
                        "storageProfile": {
                          "imageReference": {
                            "publisher": "MicrosoftWindowsServer",
                            "offer": "WindowsServer",
                            "sku": "2019-Datacenter",
                            "version": "latest"
                          },
                          "osDisk": {
                            "deleteOption": "Delete",
                            "osType": "Windows",
                            "createOption": "FromImage",
                            "caching": "None",
                            "managedDisk": {
                              "storageAccountType": "Standard_LRS"
                            },
                            "name": "[format('disk-{0}-mgt', parameters('NamingStandard'))]"
                          },
                          "dataDisks": []
                        },
                        "osProfile": {
                          "computerName": "[parameters('ManagementVmName')]",
                          "adminUsername": "[parameters('VmUsername')]",
                          "adminPassword": "[parameters('VmPassword')]",
                          "windowsConfiguration": {
                            "provisionVMAgent": true,
                            "enableAutomaticUpdates": true
                          },
                          "secrets": [],
                          "allowExtensionOperations": true
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('NicName'))]",
                              "properties": {
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": false
                          }
                        },
                        "licenseType": "Windows_Server"
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('NicName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2019-07-01",
                      "name": "[format('{0}/{1}', parameters('ManagementVmName'), 'JsonADDomainExtension')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "publisher": "Microsoft.Compute",
                        "type": "JsonADDomainExtension",
                        "typeHandlerVersion": "1.3",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "Name": "[parameters('DomainName')]",
                          "User": "[parameters('DomainJoinUserPrincipalName')]",
                          "Restart": "true",
                          "Options": "3"
                        },
                        "protectedSettings": {
                          "Password": "[parameters('DomainJoinPassword')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('ManagementVmName'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('DiskEncryption')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2017-03-30",
                      "name": "[format('{0}/{1}', parameters('ManagementVmName'), 'AzureDiskEncryption')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Security",
                        "type": "AzureDiskEncryption",
                        "typeHandlerVersion": "2.2",
                        "autoUpgradeMinorVersion": true,
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "settings": {
                          "EncryptionOperation": "EnableEncryption",
                          "KeyVaultURL": "[reference(resourceId(variables('ManagementResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('KeyVaultName')), '2016-10-01', 'Full').properties.vaultUri]",
                          "KeyVaultResourceId": "[resourceId(variables('ManagementResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('KeyVaultName'))]",
                          "KeyEncryptionKeyURL": "[reference(resourceId(variables('DeploymentResourceGroup'), 'Microsoft.Resources/deploymentScripts', format('ds-{0}-bitlockerKek', parameters('NamingStandard'))), '2019-10-01-preview', 'Full').properties.outputs.text]",
                          "KekVaultResourceId": "[resourceId(variables('ManagementResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('KeyVaultName'))]",
                          "KeyEncryptionAlgorithm": "RSA-OAEP",
                          "VolumeType": "All",
                          "ResizeOSDisk": false
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('ManagementVmName'), 'JsonADDomainExtension')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('ManagementVmName'))]"
                      ]
                    }
                  ]
                }
              }
            },
            {
              "condition": "[and(equals(parameters('StorageSolution'), 'AzureNetAppFiles'), not(contains(parameters('DomainServices'), 'None')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('AzureNetAppFiles_{0}', parameters('Timestamp'))]",
              "resourceGroup": "[parameters('ResourceGroups')[3]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ActiveDirectoryConnection": {
                    "value": "[parameters('ActiveDirectoryConnection')]"
                  },
                  "DelegatedSubnetId": {
                    "value": "[parameters('DelegatedSubnetId')]"
                  },
                  "DnsServers": {
                    "value": "[parameters('DnsServers')]"
                  },
                  "DomainJoinPassword": {
                    "value": "[parameters('DomainJoinPassword')]"
                  },
                  "DomainJoinUserPrincipalName": {
                    "value": "[parameters('DomainJoinUserPrincipalName')]"
                  },
                  "DomainName": {
                    "value": "[parameters('DomainName')]"
                  },
                  "HostPoolName": {
                    "value": "[parameters('HostPoolName')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "ManagementVmName": {
                    "value": "[parameters('ManagementVmName')]"
                  },
                  "NetAppAccountName": {
                    "value": "[parameters('NetAppAccountName')]"
                  },
                  "NetAppCapacityPoolName": {
                    "value": "[parameters('NetAppCapacityPoolName')]"
                  },
                  "OuPath": {
                    "value": "[parameters('OuPath')]"
                  },
                  "NamingStandard": {
                    "value": "[parameters('NamingStandard')]"
                  },
                  "SasToken": {
                    "value": "[parameters('SasToken')]"
                  },
                  "ScriptsUri": {
                    "value": "[parameters('ScriptsUri')]"
                  },
                  "SecurityPrincipalNames": {
                    "value": "[parameters('SecurityPrincipalNames')]"
                  },
                  "SmbServerLocation": {
                    "value": "[parameters('SmbServerLocation')]"
                  },
                  "StorageSku": {
                    "value": "[parameters('StorageSku')]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.18.56646",
                      "templateHash": "5382912982966050702"
                    }
                  },
                  "parameters": {
                    "ActiveDirectoryConnection": {
                      "type": "string"
                    },
                    "DelegatedSubnetId": {
                      "type": "string"
                    },
                    "DnsServers": {
                      "type": "string"
                    },
                    "DomainJoinPassword": {
                      "type": "secureString"
                    },
                    "DomainJoinUserPrincipalName": {
                      "type": "string"
                    },
                    "DomainName": {
                      "type": "string"
                    },
                    "HostPoolName": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "ManagementVmName": {
                      "type": "string"
                    },
                    "NetAppAccountName": {
                      "type": "string"
                    },
                    "NetAppCapacityPoolName": {
                      "type": "string"
                    },
                    "OuPath": {
                      "type": "string"
                    },
                    "NamingStandard": {
                      "type": "string"
                    },
                    "SasToken": {
                      "type": "string"
                    },
                    "ScriptsUri": {
                      "type": "string"
                    },
                    "SecurityPrincipalNames": {
                      "type": "array"
                    },
                    "SmbServerLocation": {
                      "type": "string"
                    },
                    "StorageSku": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    },
                    "Timestamp": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.NetApp/netAppAccounts",
                      "apiVersion": "2021-06-01",
                      "name": "[parameters('NetAppAccountName')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "activeDirectories": "[if(equals(parameters('ActiveDirectoryConnection'), 'false'), null(), createArray(createObject('aesEncryption', false(), 'domain', parameters('DomainName'), 'dns', parameters('DnsServers'), 'organizationalUnit', parameters('OuPath'), 'password', parameters('DomainJoinPassword'), 'smbServerName', format('anf-{0}', parameters('SmbServerLocation')), 'username', split(parameters('DomainJoinUserPrincipalName'), '@')[0])))]",
                        "encryption": {
                          "keySource": "Microsoft.NetApp"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.NetApp/netAppAccounts/capacityPools",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}', parameters('NetAppAccountName'), parameters('NetAppCapacityPoolName'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "coolAccess": false,
                        "encryptionType": "Single",
                        "qosType": "Auto",
                        "serviceLevel": "[parameters('StorageSku')]",
                        "size": 4398046511104
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.NetApp/netAppAccounts', parameters('NetAppAccountName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.NetApp/netAppAccounts/capacityPools/volumes",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}/{2}', parameters('NetAppAccountName'), parameters('NetAppCapacityPoolName'), parameters('HostPoolName'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "avsDataStore": "Disabled",
                        "coolAccess": false,
                        "creationToken": "[parameters('HostPoolName')]",
                        "defaultGroupQuotaInKiBs": 0,
                        "defaultUserQuotaInKiBs": 0,
                        "encryptionKeySource": "Microsoft.NetApp",
                        "isDefaultQuotaEnabled": false,
                        "kerberosEnabled": false,
                        "ldapEnabled": false,
                        "networkFeatures": "Basic",
                        "protocolTypes": [
                          "CIFS"
                        ],
                        "securityStyle": "ntfs",
                        "serviceLevel": "[parameters('StorageSku')]",
                        "smbEncryption": true,
                        "snapshotDirectoryVisible": true,
                        "subnetId": "[parameters('DelegatedSubnetId')]",
                        "usageThreshold": 107374182400
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.NetApp/netAppAccounts/capacityPools', parameters('NetAppAccountName'), parameters('NetAppCapacityPoolName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2020-12-01",
                      "name": "[format('{0}/CustomScriptExtension', parameters('ManagementVmName'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "CustomScriptExtension",
                        "typeHandlerVersion": "1.10",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "fileUris": [
                            "[format('{0}Set-NetAppNtfsPermissions.ps1{1}', parameters('ScriptsUri'), parameters('SasToken'))]"
                          ],
                          "timestamp": "[parameters('Timestamp')]"
                        },
                        "protectedSettings": {
                          "commandToExecute": "[format('powershell -ExecutionPolicy Unrestricted -File Set-NetAppNtfsPermissions.ps1 -DomainJoinPassword \"{0}\" -DomainJoinUserPrincipalName {1} -HostPoolName {2} -NamingStandard {3} -SecurityPrincipalNames \"{4}\" -SmbServerLocation {5}', parameters('DomainJoinPassword'), parameters('DomainJoinUserPrincipalName'), parameters('HostPoolName'), parameters('NamingStandard'), parameters('SecurityPrincipalNames'), parameters('SmbServerLocation'))]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.NetApp/netAppAccounts/capacityPools/volumes', parameters('NetAppAccountName'), parameters('NetAppCapacityPoolName'), parameters('HostPoolName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "fileShare": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.NetApp/netAppAccounts/capacityPools/volumes', parameters('NetAppAccountName'), parameters('NetAppCapacityPoolName'), parameters('HostPoolName'))).mountTargets[0].smbServerFqdn]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('ManagementVirtualMachine_{0}', parameters('Timestamp')))]"
              ]
            },
            {
              "condition": "[and(equals(parameters('StorageSolution'), 'AzureStorageAccount'), not(contains(parameters('DomainServices'), 'None')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('AzureFiles_{0}', parameters('Timestamp'))]",
              "resourceGroup": "[parameters('ResourceGroups')[3]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ConfigurationsUri": {
                    "value": "[parameters('ConfigurationsUri')]"
                  },
                  "DnsServerForwarderIPAddresses": {
                    "value": "[parameters('DnsServerForwarderIPAddresses')]"
                  },
                  "DnsServerSize": {
                    "value": "[parameters('DnsServerSize')]"
                  },
                  "DomainJoinPassword": {
                    "value": "[parameters('DomainJoinPassword')]"
                  },
                  "DomainJoinUserPrincipalName": {
                    "value": "[parameters('DomainJoinUserPrincipalName')]"
                  },
                  "DomainName": {
                    "value": "[parameters('DomainName')]"
                  },
                  "DomainServices": {
                    "value": "[parameters('DomainServices')]"
                  },
                  "Environment": {
                    "value": "[parameters('Environment')]"
                  },
                  "FileShares": {
                    "value": "[parameters('FileShares')]"
                  },
                  "FslogixShareSizeInGB": {
                    "value": "[parameters('FslogixShareSizeInGB')]"
                  },
                  "FslogixStorage": {
                    "value": "[parameters('FslogixStorage')]"
                  },
                  "HybridUseBenefit": {
                    "value": "[parameters('HybridUseBenefit')]"
                  },
                  "Identifier": {
                    "value": "[parameters('Identifier')]"
                  },
                  "KerberosEncryption": {
                    "value": "[parameters('KerberosEncryption')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "LocationShortName": {
                    "value": "[parameters('LocationShortName')]"
                  },
                  "ManagedIdentityResourceId": {
                    "value": "[parameters('ManagedIdentityResourceId')]"
                  },
                  "ManagementVmName": {
                    "value": "[parameters('ManagementVmName')]"
                  },
                  "NamingStandard": {
                    "value": "[parameters('NamingStandard')]"
                  },
                  "Netbios": {
                    "value": "[parameters('Netbios')]"
                  },
                  "OuPath": {
                    "value": "[parameters('OuPath')]"
                  },
                  "PrivateDnsZoneName": {
                    "value": "[parameters('PrivateDnsZoneName')]"
                  },
                  "PrivateEndpoint": {
                    "value": "[parameters('PrivateEndpoint')]"
                  },
                  "ResourceGroups": {
                    "value": "[parameters('ResourceGroups')]"
                  },
                  "RoleDefinitionIds": {
                    "value": "[parameters('RoleDefinitionIds')]"
                  },
                  "SasToken": {
                    "value": "[parameters('SasToken')]"
                  },
                  "ScriptsUri": {
                    "value": "[parameters('ScriptsUri')]"
                  },
                  "SecurityPrincipalIds": {
                    "value": "[parameters('SecurityPrincipalIds')]"
                  },
                  "SecurityPrincipalNames": {
                    "value": "[parameters('SecurityPrincipalNames')]"
                  },
                  "StampIndexFull": {
                    "value": "[parameters('StampIndexFull')]"
                  },
                  "StorageAccountPrefix": {
                    "value": "[parameters('StorageAccountPrefix')]"
                  },
                  "StorageCount": {
                    "value": "[parameters('StorageCount')]"
                  },
                  "StorageIndex": {
                    "value": "[parameters('StorageIndex')]"
                  },
                  "StorageSku": {
                    "value": "[parameters('StorageSku')]"
                  },
                  "StorageSuffix": {
                    "value": "[parameters('StorageSuffix')]"
                  },
                  "Subnet": {
                    "value": "[parameters('Subnet')]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "VirtualNetwork": {
                    "value": "[parameters('VirtualNetwork')]"
                  },
                  "VirtualNetworkResourceGroup": {
                    "value": "[parameters('VirtualNetworkResourceGroup')]"
                  },
                  "VmPassword": {
                    "value": "[parameters('VmPassword')]"
                  },
                  "VmUsername": {
                    "value": "[parameters('VmUsername')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.18.56646",
                      "templateHash": "5831491992683011870"
                    }
                  },
                  "parameters": {
                    "ConfigurationsUri": {
                      "type": "string"
                    },
                    "DnsServerForwarderIPAddresses": {
                      "type": "array"
                    },
                    "DnsServerSize": {
                      "type": "string"
                    },
                    "DomainJoinPassword": {
                      "type": "secureString"
                    },
                    "DomainJoinUserPrincipalName": {
                      "type": "string"
                    },
                    "DomainName": {
                      "type": "string"
                    },
                    "DomainServices": {
                      "type": "string"
                    },
                    "Environment": {
                      "type": "string"
                    },
                    "FileShares": {
                      "type": "array"
                    },
                    "FslogixShareSizeInGB": {
                      "type": "int"
                    },
                    "FslogixStorage": {
                      "type": "string"
                    },
                    "HybridUseBenefit": {
                      "type": "bool"
                    },
                    "Identifier": {
                      "type": "string"
                    },
                    "KerberosEncryption": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "LocationShortName": {
                      "type": "string"
                    },
                    "ManagedIdentityResourceId": {
                      "type": "string"
                    },
                    "ManagementVmName": {
                      "type": "string"
                    },
                    "NamingStandard": {
                      "type": "string"
                    },
                    "Netbios": {
                      "type": "string"
                    },
                    "OuPath": {
                      "type": "string"
                    },
                    "PrivateDnsZoneName": {
                      "type": "string"
                    },
                    "PrivateEndpoint": {
                      "type": "bool"
                    },
                    "ResourceGroups": {
                      "type": "array"
                    },
                    "RoleDefinitionIds": {
                      "type": "object"
                    },
                    "SasToken": {
                      "type": "string"
                    },
                    "ScriptsUri": {
                      "type": "string"
                    },
                    "SecurityPrincipalIds": {
                      "type": "array"
                    },
                    "SecurityPrincipalNames": {
                      "type": "array"
                    },
                    "StampIndexFull": {
                      "type": "string"
                    },
                    "StorageAccountPrefix": {
                      "type": "string"
                    },
                    "StorageCount": {
                      "type": "int"
                    },
                    "StorageIndex": {
                      "type": "int"
                    },
                    "StorageSku": {
                      "type": "string"
                    },
                    "StorageSuffix": {
                      "type": "string"
                    },
                    "Subnet": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "VirtualNetwork": {
                      "type": "string"
                    },
                    "VirtualNetworkResourceGroup": {
                      "type": "string"
                    },
                    "VmPassword": {
                      "type": "secureString"
                    },
                    "VmUsername": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "DeploymentResourceGroup": "[parameters('ResourceGroups')[0]]",
                    "Endpoint": "[split(parameters('FslogixStorage'), ' ')[2]]",
                    "ResourceGroupName": "[resourceGroup().name]",
                    "SmbMultiChannel": {
                      "multichannel": {
                        "enabled": true
                      }
                    },
                    "SmbSettings": {
                      "versions": "SMB3.0;SMB3.1.1;",
                      "authenticationMethods": "NTLMv2;Kerberos;",
                      "kerberosTicketEncryption": "[if(equals(parameters('KerberosEncryption'), 'RC4'), 'RC4-HMAC;', 'AES-256;')]",
                      "channelEncryption": "AES-128-CCM;AES-128-GCM;AES-256-GCM;"
                    },
                    "SubnetId": "[resourceId(parameters('VirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('VirtualNetwork'), parameters('Subnet'))]",
                    "VirtualNetworkRules": {
                      "PrivateEndpoint": [],
                      "PublicEndpoint": [],
                      "ServiceEndpoint": [
                        {
                          "id": "[variables('SubnetId')]",
                          "action": "Allow"
                        }
                      ]
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "storageAccounts",
                        "count": "[length(range(parameters('StorageIndex'), parameters('StorageCount')))]"
                      },
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()], 2, '0'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "sku": {
                        "name": "[if(equals(parameters('StorageSku'), 'Standard'), 'Standard_LRS', 'Premium_LRS')]"
                      },
                      "kind": "[if(equals(parameters('StorageSku'), 'Standard'), 'StorageV2', 'FileStorage')]",
                      "properties": {
                        "minimumTlsVersion": "TLS1_2",
                        "networkAcls": {
                          "bypass": "AzureServices",
                          "virtualNetworkRules": "[variables('VirtualNetworkRules')[variables('Endpoint')]]",
                          "ipRules": [],
                          "defaultAction": "[if(equals(variables('Endpoint'), 'PublicEndpoint'), 'Allow', 'Deny')]"
                        },
                        "supportsHttpsTrafficOnly": true,
                        "encryption": {
                          "services": {
                            "file": {
                              "keyType": "Account",
                              "enabled": true
                            }
                          },
                          "keySource": "Microsoft.Storage"
                        },
                        "azureFilesIdentityBasedAuthentication": {
                          "directoryServiceOptions": "[if(equals(parameters('DomainServices'), 'AzureActiveDirectory'), 'AADDS', 'None')]"
                        },
                        "largeFileSharesState": "[if(equals(parameters('StorageSku'), 'Standard'), 'Enabled', null())]"
                      }
                    },
                    {
                      "copy": {
                        "name": "roleAssignment_Vm",
                        "count": "[length(range(parameters('StorageIndex'), parameters('StorageCount')))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-04-01-preview",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')))]",
                      "name": "[guid(format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')), parameters('RoleDefinitionIds').contributor, parameters('ManagementVmName'))]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('RoleDefinitionIds').contributor)]",
                        "principalId": "[reference(resourceId(variables('DeploymentResourceGroup'), 'Microsoft.Compute/virtualMachines', parameters('ManagementVmName')), '2020-12-01', 'Full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')))]",
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "roleAssignment_Users",
                        "count": "[length(range(parameters('StorageIndex'), parameters('StorageCount')))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-04-01-preview",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')))]",
                      "name": "[guid(parameters('SecurityPrincipalIds')[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], parameters('RoleDefinitionIds').storageFileDataSMBShareContributor, format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')))]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('RoleDefinitionIds').storageFileDataSMBShareContributor)]",
                        "principalId": "[parameters('SecurityPrincipalIds')[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]]]"
                      },
                      "dependsOn": [
                        "roleAssignment_Vm",
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')))]",
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "fileServices",
                        "count": "[length(range(parameters('StorageIndex'), parameters('StorageCount')))]"
                      },
                      "type": "Microsoft.Storage/storageAccounts/fileServices",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/{1}', format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')), 'default')]",
                      "properties": {
                        "protocolSettings": {
                          "smb": "[if(equals(parameters('StorageSku'), 'Standard'), variables('SmbSettings'), union(variables('SmbSettings'), variables('SmbMultiChannel')))]"
                        },
                        "shareDeleteRetentionPolicy": {
                          "enabled": false
                        }
                      },
                      "dependsOn": [
                        "roleAssignment_Vm",
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "shares",
                        "count": "[length(range(parameters('StorageIndex'), parameters('StorageCount')))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[format('FileShares_{0}_{1}', range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()], parameters('Timestamp'))]",
                      "resourceGroup": "[parameters('ResourceGroups')[3]]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "FileShares": {
                            "value": "[parameters('FileShares')]"
                          },
                          "FslogixShareSizeInGB": {
                            "value": "[parameters('FslogixShareSizeInGB')]"
                          },
                          "StorageAccountName": {
                            "value": "[format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()], 2, '0'))]"
                          },
                          "StorageSku": {
                            "value": "[parameters('StorageSku')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.6.18.56646",
                              "templateHash": "16669082103725186238"
                            }
                          },
                          "parameters": {
                            "FileShares": {
                              "type": "array"
                            },
                            "FslogixShareSizeInGB": {
                              "type": "int"
                            },
                            "StorageAccountName": {
                              "type": "string"
                            },
                            "StorageSku": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "shares",
                                "count": "[length(range(0, length(parameters('FileShares'))))]"
                              },
                              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
                              "apiVersion": "2021-02-01",
                              "name": "[format('{0}/default/{1}', parameters('StorageAccountName'), parameters('FileShares')[range(0, length(parameters('FileShares')))[copyIndex()]])]",
                              "properties": {
                                "accessTier": "[if(equals(parameters('StorageSku'), 'Premium'), 'Premium', 'TransactionOptimized')]",
                                "shareQuota": "[parameters('FslogixShareSizeInGB')]",
                                "enabledProtocols": "SMB"
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "roleAssignment_Users"
                      ]
                    },
                    {
                      "condition": "[parameters('PrivateEndpoint')]",
                      "copy": {
                        "name": "privateEndpoint",
                        "count": "[length(range(parameters('StorageIndex'), parameters('StorageCount')))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[format('PrivateEndpoints_{0}_{1}', range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()], parameters('Timestamp'))]",
                      "resourceGroup": "[variables('ResourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "Location": {
                            "value": "[parameters('Location')]"
                          },
                          "PrivateDnsZoneName": {
                            "value": "[parameters('PrivateDnsZoneName')]"
                          },
                          "StorageAccountId": {
                            "value": "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')))]"
                          },
                          "StorageAccountName": {
                            "value": "[format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0'))]"
                          },
                          "Subnet": {
                            "value": "[parameters('Subnet')]"
                          },
                          "Tags": {
                            "value": "[parameters('Tags')]"
                          },
                          "VirtualNetwork": {
                            "value": "[parameters('VirtualNetwork')]"
                          },
                          "VirtualNetworkResourceGroup": {
                            "value": "[parameters('VirtualNetworkResourceGroup')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.6.18.56646",
                              "templateHash": "5308930885733199198"
                            }
                          },
                          "parameters": {
                            "Location": {
                              "type": "string"
                            },
                            "PrivateDnsZoneName": {
                              "type": "string"
                            },
                            "StorageAccountId": {
                              "type": "string"
                            },
                            "StorageAccountName": {
                              "type": "string"
                            },
                            "Subnet": {
                              "type": "string"
                            },
                            "Tags": {
                              "type": "object"
                            },
                            "VirtualNetwork": {
                              "type": "string"
                            },
                            "VirtualNetworkResourceGroup": {
                              "type": "string"
                            }
                          },
                          "variables": {
                            "SubnetId": "[resourceId(parameters('VirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('VirtualNetwork'), parameters('Subnet'))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2018-09-01",
                              "name": "[parameters('PrivateDnsZoneName')]",
                              "location": "global",
                              "tags": "[parameters('Tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2020-05-01",
                              "name": "[format('pe-{0}', parameters('StorageAccountName'))]",
                              "location": "[parameters('Location')]",
                              "tags": "[parameters('Tags')]",
                              "properties": {
                                "subnet": {
                                  "id": "[variables('SubnetId')]"
                                },
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[format('pe-{0}_{1}', parameters('StorageAccountName'), guid(parameters('StorageAccountName')))]",
                                    "properties": {
                                      "privateLinkServiceId": "[parameters('StorageAccountId')]",
                                      "groupIds": [
                                        "file"
                                      ]
                                    }
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2021-08-01",
                              "name": "[format('{0}/{1}', format('pe-{0}', parameters('StorageAccountName')), parameters('StorageAccountName'))]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "ipconfig1",
                                    "properties": {
                                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', parameters('PrivateDnsZoneName'))]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('PrivateDnsZoneName'))]",
                                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}', parameters('StorageAccountName')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2018-09-01",
                              "name": "[format('{0}/{1}', parameters('PrivateDnsZoneName'), format('link-{0}', parameters('VirtualNetwork')))]",
                              "location": "global",
                              "tags": "[parameters('Tags')]",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[resourceId(parameters('VirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks', parameters('VirtualNetwork'))]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('PrivateDnsZoneName'))]"
                              ]
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')))]",
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), padLeft(range(parameters('StorageIndex'), parameters('StorageCount'))[range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]], 2, '0')))]"
                      ]
                    },
                    {
                      "condition": "[parameters('PrivateEndpoint')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[format('DnsForwarder_{0}', parameters('Timestamp'))]",
                      "resourceGroup": "[variables('ResourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "ConfigurationsUri": {
                            "value": "[parameters('ConfigurationsUri')]"
                          },
                          "DnsServerForwarderIPAddresses": {
                            "value": "[parameters('DnsServerForwarderIPAddresses')]"
                          },
                          "DnsServerSize": {
                            "value": "[parameters('DnsServerSize')]"
                          },
                          "DomainJoinPassword": {
                            "value": "[parameters('DomainJoinPassword')]"
                          },
                          "DomainJoinUserPrincipalName": {
                            "value": "[parameters('DomainJoinUserPrincipalName')]"
                          },
                          "DomainName": {
                            "value": "[parameters('DomainName')]"
                          },
                          "Environment": {
                            "value": "[parameters('Environment')]"
                          },
                          "HybridUseBenefit": {
                            "value": "[parameters('HybridUseBenefit')]"
                          },
                          "Identifier": {
                            "value": "[parameters('Identifier')]"
                          },
                          "Location": {
                            "value": "[parameters('Location')]"
                          },
                          "LocationShortName": {
                            "value": "[parameters('LocationShortName')]"
                          },
                          "ManagedIdentityResourceId": {
                            "value": "[parameters('ManagedIdentityResourceId')]"
                          },
                          "NamingStandard": {
                            "value": "[parameters('NamingStandard')]"
                          },
                          "SasToken": {
                            "value": "[parameters('SasToken')]"
                          },
                          "ScriptsUri": {
                            "value": "[parameters('ScriptsUri')]"
                          },
                          "StampIndexFull": {
                            "value": "[parameters('StampIndexFull')]"
                          },
                          "StorageSuffix": {
                            "value": "[parameters('StorageSuffix')]"
                          },
                          "Subnet": {
                            "value": "[parameters('Subnet')]"
                          },
                          "Tags": {
                            "value": "[parameters('Tags')]"
                          },
                          "Timestamp": {
                            "value": "[parameters('Timestamp')]"
                          },
                          "VirtualNetwork": {
                            "value": "[parameters('VirtualNetwork')]"
                          },
                          "VirtualNetworkResourceGroup": {
                            "value": "[parameters('VirtualNetworkResourceGroup')]"
                          },
                          "VmPassword": {
                            "value": "[parameters('VmPassword')]"
                          },
                          "VmUsername": {
                            "value": "[parameters('VmUsername')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.6.18.56646",
                              "templateHash": "1723813284651791591"
                            }
                          },
                          "parameters": {
                            "ConfigurationsUri": {
                              "type": "string"
                            },
                            "DnsServerForwarderIPAddresses": {
                              "type": "array"
                            },
                            "DnsServerSize": {
                              "type": "string"
                            },
                            "DomainJoinPassword": {
                              "type": "secureString"
                            },
                            "DomainJoinUserPrincipalName": {
                              "type": "string"
                            },
                            "DomainName": {
                              "type": "string"
                            },
                            "Environment": {
                              "type": "string"
                            },
                            "HybridUseBenefit": {
                              "type": "bool"
                            },
                            "Identifier": {
                              "type": "string"
                            },
                            "Location": {
                              "type": "string"
                            },
                            "LocationShortName": {
                              "type": "string"
                            },
                            "ManagedIdentityResourceId": {
                              "type": "string"
                            },
                            "NamingStandard": {
                              "type": "string"
                            },
                            "SasToken": {
                              "type": "string"
                            },
                            "ScriptsUri": {
                              "type": "string"
                            },
                            "StampIndexFull": {
                              "type": "string"
                            },
                            "StorageSuffix": {
                              "type": "string"
                            },
                            "Subnet": {
                              "type": "string"
                            },
                            "Tags": {
                              "type": "object"
                            },
                            "Timestamp": {
                              "type": "string"
                            },
                            "VirtualNetwork": {
                              "type": "string"
                            },
                            "VirtualNetworkResourceGroup": {
                              "type": "string"
                            },
                            "VmPassword": {
                              "type": "secureString"
                            },
                            "VmUsername": {
                              "type": "string"
                            }
                          },
                          "variables": {
                            "SubnetId": "[resourceId(parameters('VirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('VirtualNetwork'), parameters('Subnet'))]",
                            "VmName": "[format('vm{0}{1}{2}{3}dns', parameters('Identifier'), parameters('Environment'), parameters('LocationShortName'), parameters('StampIndexFull'))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deploymentScripts",
                              "apiVersion": "2020-10-01",
                              "name": "[format('ds-{0}-getDns', parameters('NamingStandard'))]",
                              "location": "[parameters('Location')]",
                              "kind": "AzurePowerShell",
                              "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                  "[format('{0}', parameters('ManagedIdentityResourceId'))]": {}
                                }
                              },
                              "properties": {
                                "forceUpdateTag": "[parameters('Timestamp')]",
                                "azPowerShellVersion": "5.4",
                                "arguments": "[format('-Subnet {0} -VirtualNetwork {1} -VirtualNetworkResourceGroup {2}', parameters('Subnet'), parameters('VirtualNetwork'), parameters('VirtualNetworkResourceGroup'))]",
                                "primaryScriptUri": "[format('{0}Get-AzureVirtualNetworkDns.ps1{1}', parameters('ScriptsUri'), parameters('SasToken'))]",
                                "timeout": "PT4H",
                                "cleanupPreference": "OnSuccess",
                                "retentionInterval": "P1D"
                              }
                            },
                            {
                              "type": "Microsoft.Network/networkInterfaces",
                              "apiVersion": "2020-05-01",
                              "name": "[format('nic-{0}-dns', parameters('NamingStandard'))]",
                              "location": "[parameters('Location')]",
                              "tags": "[parameters('Tags')]",
                              "properties": {
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfig1",
                                    "properties": {
                                      "privateIPAllocationMethod": "Dynamic",
                                      "subnet": {
                                        "id": "[variables('SubnetId')]"
                                      },
                                      "primary": true,
                                      "privateIPAddressVersion": "IPv4"
                                    }
                                  }
                                ],
                                "enableAcceleratedNetworking": true,
                                "enableIPForwarding": false
                              }
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2019-07-01",
                              "name": "[variables('VmName')]",
                              "location": "[parameters('Location')]",
                              "tags": "[parameters('Tags')]",
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('DnsServerSize')]"
                                },
                                "storageProfile": {
                                  "imageReference": {
                                    "publisher": "MicrosoftWindowsServer",
                                    "offer": "WindowsServer",
                                    "sku": "2019-Datacenter-Core",
                                    "version": "latest"
                                  },
                                  "osDisk": {
                                    "osType": "Windows",
                                    "name": "[format('disk-{0}-dns', parameters('NamingStandard'))]",
                                    "createOption": "FromImage",
                                    "caching": "ReadWrite",
                                    "managedDisk": {
                                      "storageAccountType": "Premium_LRS"
                                    }
                                  }
                                },
                                "osProfile": {
                                  "computerName": "[variables('VmName')]",
                                  "adminUsername": "[parameters('VmUsername')]",
                                  "adminPassword": "[parameters('VmPassword')]",
                                  "windowsConfiguration": {
                                    "provisionVMAgent": true,
                                    "enableAutomaticUpdates": true
                                  },
                                  "secrets": [],
                                  "allowExtensionOperations": true
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}-dns', parameters('NamingStandard')))]"
                                    }
                                  ]
                                },
                                "licenseType": "[if(parameters('HybridUseBenefit'), 'Windows_Server', json('null'))]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}-dns', parameters('NamingStandard')))]",
                                "[resourceId('Microsoft.Resources/deployments', 'staticIpAddress')]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2019-07-01",
                              "name": "[format('{0}/JsonADDomainExtension', variables('VmName'))]",
                              "location": "[parameters('Location')]",
                              "tags": "[parameters('Tags')]",
                              "properties": {
                                "forceUpdateTag": "[parameters('Timestamp')]",
                                "publisher": "Microsoft.Compute",
                                "type": "JsonADDomainExtension",
                                "typeHandlerVersion": "1.3",
                                "autoUpgradeMinorVersion": true,
                                "settings": {
                                  "Name": "[parameters('DomainName')]",
                                  "User": "[parameters('DomainJoinUserPrincipalName')]",
                                  "Restart": "true",
                                  "Options": "3"
                                },
                                "protectedSettings": {
                                  "Password": "[parameters('DomainJoinPassword')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('VmName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2019-07-01",
                              "name": "[format('{0}/DSC', variables('VmName'))]",
                              "location": "[parameters('Location')]",
                              "tags": "[parameters('Tags')]",
                              "properties": {
                                "forceUpdateTag": "[parameters('Timestamp')]",
                                "autoUpgradeMinorVersion": true,
                                "publisher": "Microsoft.Powershell",
                                "type": "DSC",
                                "typeHandlerVersion": "2.77",
                                "settings": {
                                  "modulesUrl": "[format('{0}dnsForwarder.zip{1}', parameters('ConfigurationsUri'), parameters('SasToken'))]",
                                  "configurationFunction": "dnsForwarder.ps1\\dnsForwarder",
                                  "configurationArguments": {
                                    "ActionAfterReboot": "ContinueConfiguration",
                                    "ConfigurationMode": "ApplyandAutoCorrect",
                                    "RebootNodeIfNeeded": true
                                  },
                                  "properties": [
                                    {
                                      "Name": "ForwarderIPAddresses",
                                      "Value": "[parameters('DnsServerForwarderIPAddresses')]",
                                      "TypeName": "System.Array"
                                    },
                                    {
                                      "Name": "StorageSuffix",
                                      "Value": "[parameters('StorageSuffix')]",
                                      "TypeName": "System.String"
                                    }
                                  ]
                                },
                                "protectedSettings": {}
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/JsonADDomainExtension', variables('VmName')), '/')[0], split(format('{0}/JsonADDomainExtension', variables('VmName')), '/')[1])]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('VmName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deploymentScripts",
                              "apiVersion": "2020-10-01",
                              "name": "[format('ds-{0}-setDns', parameters('NamingStandard'))]",
                              "location": "[parameters('Location')]",
                              "kind": "AzurePowerShell",
                              "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                  "[format('{0}', parameters('ManagedIdentityResourceId'))]": {}
                                }
                              },
                              "properties": {
                                "forceUpdateTag": "[parameters('Timestamp')]",
                                "azPowerShellVersion": "5.4",
                                "arguments": "[format('-Dns {0} -VirtualNetwork {1} -VirtualNetworkResourceGroup {2}', reference(resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}-dns', parameters('NamingStandard')))).ipConfigurations[0].properties.privateIPAddress, parameters('VirtualNetwork'), parameters('VirtualNetworkResourceGroup'))]",
                                "primaryScriptUri": "[format('{0}Set-AzureVirtualNetworkDns.ps1{1}', parameters('ScriptsUri'), parameters('SasToken'))]",
                                "timeout": "PT4H",
                                "cleanupPreference": "OnSuccess",
                                "retentionInterval": "P1D"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/DSC', variables('VmName')), '/')[0], split(format('{0}/DSC', variables('VmName')), '/')[1])]",
                                "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}-dns', parameters('NamingStandard')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2020-10-01",
                              "name": "staticIpAddress",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "IpAddress": {
                                    "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}-dns', parameters('NamingStandard')))).ipConfigurations[0].properties.privateIPAddress]"
                                  },
                                  "Location": {
                                    "value": "[parameters('Location')]"
                                  },
                                  "NicName": {
                                    "value": "[format('nic-{0}-dns', parameters('NamingStandard'))]"
                                  },
                                  "SubnetId": {
                                    "value": "[variables('SubnetId')]"
                                  },
                                  "Tags": {
                                    "value": "[parameters('Tags')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.6.18.56646",
                                      "templateHash": "4558971688714966977"
                                    }
                                  },
                                  "parameters": {
                                    "IpAddress": {
                                      "type": "string"
                                    },
                                    "Location": {
                                      "type": "string"
                                    },
                                    "NicName": {
                                      "type": "string"
                                    },
                                    "SubnetId": {
                                      "type": "string"
                                    },
                                    "Tags": {
                                      "type": "object"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/networkInterfaces",
                                      "apiVersion": "2021-08-01",
                                      "name": "[parameters('NicName')]",
                                      "location": "[parameters('Location')]",
                                      "tags": "[parameters('Tags')]",
                                      "properties": {
                                        "ipConfigurations": [
                                          {
                                            "name": "ipconfig1",
                                            "properties": {
                                              "privateIPAddress": "[parameters('IpAddress')]",
                                              "privateIPAllocationMethod": "Static",
                                              "subnet": {
                                                "id": "[parameters('SubnetId')]"
                                              },
                                              "primary": true,
                                              "privateIPAddressVersion": "IPv4"
                                            }
                                          }
                                        ],
                                        "enableAcceleratedNetworking": true,
                                        "enableIPForwarding": false
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}-dns', parameters('NamingStandard')))]"
                              ]
                            }
                          ]
                        }
                      }
                    },
                    {
                      "condition": "[not(contains(parameters('DomainServices'), 'None'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[format('FslogixNtfsPermissions_{0}', parameters('Timestamp'))]",
                      "resourceGroup": "[parameters('ResourceGroups')[0]]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "DomainJoinPassword": {
                            "value": "[parameters('DomainJoinPassword')]"
                          },
                          "DomainJoinUserPrincipalName": {
                            "value": "[parameters('DomainJoinUserPrincipalName')]"
                          },
                          "DomainServices": {
                            "value": "[parameters('DomainServices')]"
                          },
                          "KerberosEncryptionType": {
                            "value": "[parameters('KerberosEncryption')]"
                          },
                          "Location": {
                            "value": "[parameters('Location')]"
                          },
                          "ManagementVmName": {
                            "value": "[parameters('ManagementVmName')]"
                          },
                          "Netbios": {
                            "value": "[parameters('Netbios')]"
                          },
                          "OuPath": {
                            "value": "[parameters('OuPath')]"
                          },
                          "SasToken": {
                            "value": "[parameters('SasToken')]"
                          },
                          "ScriptsUri": {
                            "value": "[parameters('ScriptsUri')]"
                          },
                          "SecurityPrincipalNames": {
                            "value": "[parameters('SecurityPrincipalNames')]"
                          },
                          "StorageCount": {
                            "value": "[parameters('StorageCount')]"
                          },
                          "StorageIndex": {
                            "value": "[parameters('StorageIndex')]"
                          },
                          "StorageAccountPrefix": {
                            "value": "[parameters('StorageAccountPrefix')]"
                          },
                          "StorageAccountResourceGroupName": {
                            "value": "[parameters('ResourceGroups')[3]]"
                          },
                          "Tags": {
                            "value": "[parameters('Tags')]"
                          },
                          "Timestamp": {
                            "value": "[parameters('Timestamp')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.6.18.56646",
                              "templateHash": "1132828398907356806"
                            }
                          },
                          "parameters": {
                            "DomainJoinPassword": {
                              "type": "secureString"
                            },
                            "DomainJoinUserPrincipalName": {
                              "type": "string"
                            },
                            "DomainServices": {
                              "type": "string"
                            },
                            "KerberosEncryptionType": {
                              "type": "string"
                            },
                            "Location": {
                              "type": "string"
                            },
                            "ManagementVmName": {
                              "type": "string"
                            },
                            "Netbios": {
                              "type": "string"
                            },
                            "OuPath": {
                              "type": "string"
                            },
                            "SasToken": {
                              "type": "string"
                            },
                            "ScriptsUri": {
                              "type": "string"
                            },
                            "SecurityPrincipalNames": {
                              "type": "array"
                            },
                            "StorageCount": {
                              "type": "int"
                            },
                            "StorageIndex": {
                              "type": "int"
                            },
                            "StorageAccountPrefix": {
                              "type": "string"
                            },
                            "StorageAccountResourceGroupName": {
                              "type": "string"
                            },
                            "Tags": {
                              "type": "object"
                            },
                            "Timestamp": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2020-12-01",
                              "name": "[format('{0}/CustomScriptExtension', parameters('ManagementVmName'))]",
                              "location": "[parameters('Location')]",
                              "tags": "[parameters('Tags')]",
                              "properties": {
                                "publisher": "Microsoft.Compute",
                                "type": "CustomScriptExtension",
                                "typeHandlerVersion": "1.10",
                                "autoUpgradeMinorVersion": true,
                                "settings": {
                                  "fileUris": [
                                    "[format('{0}New-DomainJoinStorageAccount.ps1{1}', parameters('ScriptsUri'), parameters('SasToken'))]"
                                  ],
                                  "timestamp": "[parameters('Timestamp')]"
                                },
                                "protectedSettings": {
                                  "commandToExecute": "[format('powershell -ExecutionPolicy Unrestricted -File New-DomainJoinStorageAccount.ps1 -DomainJoinPassword \"{0}\" -DomainJoinUserPrincipalName {1} -DomainServices {2} -Environment {3} -KerberosEncryptionType {4} -Netbios {5} -OuPath \"{6}\" -SecurityPrincipalNames {7} -StorageCount {8} -StorageIndex {9} -StorageAccountPrefix {10} -StorageAccountResourceGroupName {11} -StorageSuffix {12} -SubscriptionId {13} -TenantId {14}', parameters('DomainJoinPassword'), parameters('DomainJoinUserPrincipalName'), parameters('DomainServices'), environment().name, parameters('KerberosEncryptionType'), parameters('Netbios'), parameters('OuPath'), parameters('SecurityPrincipalNames'), parameters('StorageCount'), parameters('StorageIndex'), parameters('StorageAccountPrefix'), parameters('StorageAccountResourceGroupName'), environment().suffixes.storage, subscription().subscriptionId, subscription().tenantId)]"
                                }
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupName')), 'Microsoft.Resources/deployments', format('DnsForwarder_{0}', parameters('Timestamp')))]",
                        "privateEndpoint",
                        "shares"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('ManagementVirtualMachine_{0}', parameters('Timestamp')))]"
              ]
            }
          ],
          "outputs": {
            "netAppShare": {
              "type": "string",
              "value": "[if(equals(parameters('StorageSolution'), 'AzureNetAppFiles'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroups')[3]), 'Microsoft.Resources/deployments', format('AzureNetAppFiles_{0}', parameters('Timestamp'))), '2020-10-01').outputs.fileShare.value, 'None')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[2]), 'Microsoft.Resources/deployments', format('BitLocker_{0}', parameters('Timestamp')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('ManagedIdentity_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[2]), 'Microsoft.Resources/deployments', format('STIG_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('Validation_{0}', parameters('Timestamp')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('SessionHosts_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroups')[1]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AcceleratedNetworking": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('Validation_{0}', parameters('Timestamp')))).outputs.acceleratedNetworking.value]"
          },
          "AutomationAccountName": {
            "value": "[variables('AutomationAccountName')]"
          },
          "Availability": {
            "value": "[parameters('Availability')]"
          },
          "AvailabilitySetCount": {
            "value": "[variables('AvailabilitySetCount')]"
          },
          "AvailabilitySetPrefix": {
            "value": "[variables('AvailabilitySetPrefix')]"
          },
          "ConfigurationName": {
            "value": "[variables('ConfigurationName')]"
          },
          "DisaStigCompliance": {
            "value": "[parameters('DisaStigCompliance')]"
          },
          "DiskEncryption": {
            "value": "[parameters('DiskEncryption')]"
          },
          "DiskSku": {
            "value": "[parameters('DiskSku')]"
          },
          "DivisionRemainderValue": {
            "value": "[variables('DivisionRemainderValue')]"
          },
          "DomainJoinPassword": {
            "value": "[parameters('DomainJoinPassword')]"
          },
          "DomainJoinUserPrincipalName": {
            "value": "[parameters('DomainJoinUserPrincipalName')]"
          },
          "DomainName": {
            "value": "[parameters('DomainName')]"
          },
          "DomainServices": {
            "value": "[parameters('DomainServices')]"
          },
          "EphemeralOsDisk": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('Validation_{0}', parameters('Timestamp')))).outputs.ephemeralOsDisk.value]"
          },
          "FileShares": {
            "value": "[variables('FileShares')]"
          },
          "Fslogix": {
            "value": "[variables('Fslogix')]"
          },
          "HostPoolName": {
            "value": "[variables('HostPoolName')]"
          },
          "HostPoolType": {
            "value": "[parameters('HostPoolType')]"
          },
          "ImageOffer": {
            "value": "[parameters('ImageOffer')]"
          },
          "ImagePublisher": {
            "value": "[parameters('ImagePublisher')]"
          },
          "ImageSku": {
            "value": "[parameters('ImageSku')]"
          },
          "ImageVersion": {
            "value": "[parameters('ImageVersion')]"
          },
          "KeyVaultName": {
            "value": "[variables('KeyVaultName')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "LogAnalyticsWorkspaceName": {
            "value": "[variables('LogAnalyticsWorkspaceName')]"
          },
          "MaxResourcesPerTemplateDeployment": {
            "value": "[variables('MaxResourcesPerTemplateDeployment')]"
          },
          "Monitoring": {
            "value": "[parameters('Monitoring')]"
          },
          "NamingStandard": {
            "value": "[variables('NamingStandard')]"
          },
          "NetAppFileShare": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('FSLogix_{0}', parameters('Timestamp'))), '2020-10-01').outputs.netAppShare.value]"
          },
          "NetworkSecurityGroupName": {
            "value": "[variables('NetworkSecurityGroupName')]"
          },
          "OuPath": {
            "value": "[parameters('OuPath')]"
          },
          "PooledHostPool": {
            "value": "[variables('PooledHostPool')]"
          },
          "RdpShortPath": {
            "value": "[parameters('RdpShortPath')]"
          },
          "ResourceGroups": {
            "value": "[variables('ResourceGroups')]"
          },
          "RoleDefinitionIds": {
            "value": "[variables('RoleDefinitionIds')]"
          },
          "SasToken": {
            "value": "[parameters('SasToken')]"
          },
          "ScreenCaptureProtection": {
            "value": "[parameters('ScreenCaptureProtection')]"
          },
          "ScriptsUri": {
            "value": "[variables('ScriptsUri')]"
          },
          "SecurityPrincipalObjectIds": {
            "value": "[parameters('SecurityPrincipalObjectIds')]"
          },
          "SessionHostBatchCount": {
            "value": "[variables('SessionHostBatchCount')]"
          },
          "SessionHostIndex": {
            "value": "[parameters('SessionHostIndex')]"
          },
          "StorageAccountPrefix": {
            "value": "[variables('StorageAccountPrefix')]"
          },
          "StorageCount": {
            "value": "[parameters('StorageCount')]"
          },
          "StorageIndex": {
            "value": "[parameters('StorageIndex')]"
          },
          "StorageSolution": {
            "value": "[variables('StorageSolution')]"
          },
          "StorageSuffix": {
            "value": "[variables('StorageSuffix')]"
          },
          "Subnet": {
            "value": "[parameters('Subnet')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "VirtualNetwork": {
            "value": "[parameters('VirtualNetwork')]"
          },
          "VirtualNetworkResourceGroup": {
            "value": "[parameters('VirtualNetworkResourceGroup')]"
          },
          "VmName": {
            "value": "[variables('VmName')]"
          },
          "VmPassword": {
            "value": "[parameters('VmPassword')]"
          },
          "VmSize": {
            "value": "[parameters('VmSize')]"
          },
          "VmUsername": {
            "value": "[parameters('VmUsername')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "12904255555244375948"
            }
          },
          "parameters": {
            "AcceleratedNetworking": {
              "type": "string"
            },
            "AvailabilitySetCount": {
              "type": "int"
            },
            "AvailabilitySetPrefix": {
              "type": "string"
            },
            "AutomationAccountName": {
              "type": "string"
            },
            "Availability": {
              "type": "string"
            },
            "ConfigurationName": {
              "type": "string"
            },
            "DisaStigCompliance": {
              "type": "bool"
            },
            "DiskEncryption": {
              "type": "bool"
            },
            "DiskSku": {
              "type": "string"
            },
            "DivisionRemainderValue": {
              "type": "int"
            },
            "DomainJoinPassword": {
              "type": "secureString"
            },
            "DomainJoinUserPrincipalName": {
              "type": "string"
            },
            "DomainName": {
              "type": "string"
            },
            "DomainServices": {
              "type": "string"
            },
            "EphemeralOsDisk": {
              "type": "string"
            },
            "FileShares": {
              "type": "array"
            },
            "Fslogix": {
              "type": "bool"
            },
            "HostPoolName": {
              "type": "string"
            },
            "HostPoolType": {
              "type": "string"
            },
            "ImageOffer": {
              "type": "string"
            },
            "ImagePublisher": {
              "type": "string"
            },
            "ImageSku": {
              "type": "string"
            },
            "ImageVersion": {
              "type": "string"
            },
            "KeyVaultName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "LogAnalyticsWorkspaceName": {
              "type": "string"
            },
            "MaxResourcesPerTemplateDeployment": {
              "type": "int"
            },
            "Monitoring": {
              "type": "bool"
            },
            "NamingStandard": {
              "type": "string"
            },
            "NetworkSecurityGroupName": {
              "type": "string"
            },
            "NetAppFileShare": {
              "type": "string"
            },
            "OuPath": {
              "type": "string"
            },
            "PooledHostPool": {
              "type": "bool"
            },
            "RdpShortPath": {
              "type": "bool"
            },
            "ResourceGroups": {
              "type": "array"
            },
            "RoleDefinitionIds": {
              "type": "object"
            },
            "SasToken": {
              "type": "string"
            },
            "ScreenCaptureProtection": {
              "type": "bool"
            },
            "ScriptsUri": {
              "type": "string"
            },
            "SecurityPrincipalObjectIds": {
              "type": "array"
            },
            "SessionHostBatchCount": {
              "type": "int"
            },
            "SessionHostIndex": {
              "type": "int"
            },
            "StorageAccountPrefix": {
              "type": "string"
            },
            "StorageCount": {
              "type": "int"
            },
            "StorageIndex": {
              "type": "int"
            },
            "StorageSolution": {
              "type": "string"
            },
            "StorageSuffix": {
              "type": "string"
            },
            "Subnet": {
              "type": "string"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            },
            "VirtualNetwork": {
              "type": "string"
            },
            "VirtualNetworkResourceGroup": {
              "type": "string"
            },
            "VmName": {
              "type": "string"
            },
            "VmPassword": {
              "type": "secureString"
            },
            "VmSize": {
              "type": "string"
            },
            "VmUsername": {
              "type": "string"
            }
          },
          "resources": [
            {
              "condition": "[and(parameters('PooledHostPool'), equals(parameters('Availability'), 'AvailabilitySet'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('AvailabilitySets_{0}', parameters('Timestamp'))]",
              "resourceGroup": "[parameters('ResourceGroups')[1]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "AvailabilitySetCount": {
                    "value": "[parameters('AvailabilitySetCount')]"
                  },
                  "AvailabilitySetPrefix": {
                    "value": "[parameters('AvailabilitySetPrefix')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.18.56646",
                      "templateHash": "3990935472006597077"
                    }
                  },
                  "parameters": {
                    "AvailabilitySetCount": {
                      "type": "int"
                    },
                    "AvailabilitySetPrefix": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "availabilitySet",
                        "count": "[length(range(0, parameters('AvailabilitySetCount')))]"
                      },
                      "type": "Microsoft.Compute/availabilitySets",
                      "apiVersion": "2019-07-01",
                      "name": "[format('{0}{1}', parameters('AvailabilitySetPrefix'), range(0, parameters('AvailabilitySetCount'))[copyIndex()])]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "sku": {
                        "name": "Aligned"
                      },
                      "properties": {
                        "platformUpdateDomainCount": 5,
                        "platformFaultDomainCount": 2
                      }
                    }
                  ]
                }
              }
            },
            {
              "condition": "[contains(parameters('DomainServices'), 'None')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('RoleAssignments_{0}', parameters('Timestamp'))]",
              "resourceGroup": "[parameters('ResourceGroups')[1]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "RoleDefinitionId": {
                    "value": "[parameters('RoleDefinitionIds').virtualMachineUserLogin]"
                  },
                  "SecurityPrincipalIds": {
                    "value": "[parameters('SecurityPrincipalObjectIds')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.18.56646",
                      "templateHash": "17865967807680741208"
                    }
                  },
                  "parameters": {
                    "RoleDefinitionId": {
                      "type": "string"
                    },
                    "SecurityPrincipalIds": {
                      "type": "array"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "roleAssignments",
                        "count": "[length(range(0, length(parameters('SecurityPrincipalIds'))))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2018-09-01-preview",
                      "name": "[guid(string(range(0, length(parameters('SecurityPrincipalIds')))[copyIndex()]), parameters('RoleDefinitionId'), resourceGroup().id)]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('RoleDefinitionId'))]",
                        "principalId": "[parameters('SecurityPrincipalIds')[range(0, length(parameters('SecurityPrincipalIds')))[copyIndex()]]]"
                      }
                    }
                  ]
                }
              }
            },
            {
              "copy": {
                "name": "virtualMachines",
                "count": "[length(range(1, parameters('SessionHostBatchCount')))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('VirtualMachines_{0}_{1}', sub(range(1, parameters('SessionHostBatchCount'))[copyIndex()], 1), parameters('Timestamp'))]",
              "resourceGroup": "[parameters('ResourceGroups')[1]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "AcceleratedNetworking": {
                    "value": "[parameters('AcceleratedNetworking')]"
                  },
                  "AutomationAccountName": {
                    "value": "[parameters('AutomationAccountName')]"
                  },
                  "Availability": {
                    "value": "[parameters('Availability')]"
                  },
                  "AvailabilitySetPrefix": {
                    "value": "[parameters('AvailabilitySetPrefix')]"
                  },
                  "ConfigurationName": {
                    "value": "[parameters('ConfigurationName')]"
                  },
                  "DisaStigCompliance": {
                    "value": "[parameters('DisaStigCompliance')]"
                  },
                  "DiskEncryption": {
                    "value": "[parameters('DiskEncryption')]"
                  },
                  "DiskSku": {
                    "value": "[parameters('DiskSku')]"
                  },
                  "DomainJoinPassword": {
                    "value": "[parameters('DomainJoinPassword')]"
                  },
                  "DomainJoinUserPrincipalName": {
                    "value": "[parameters('DomainJoinUserPrincipalName')]"
                  },
                  "DomainName": {
                    "value": "[parameters('DomainName')]"
                  },
                  "DomainServices": {
                    "value": "[parameters('DomainServices')]"
                  },
                  "EphemeralOsDisk": {
                    "value": "[parameters('EphemeralOsDisk')]"
                  },
                  "FileShares": {
                    "value": "[parameters('FileShares')]"
                  },
                  "Fslogix": {
                    "value": "[parameters('Fslogix')]"
                  },
                  "HostPoolName": {
                    "value": "[parameters('HostPoolName')]"
                  },
                  "HostPoolType": {
                    "value": "[parameters('HostPoolType')]"
                  },
                  "ImageOffer": {
                    "value": "[parameters('ImageOffer')]"
                  },
                  "ImagePublisher": {
                    "value": "[parameters('ImagePublisher')]"
                  },
                  "ImageSku": {
                    "value": "[parameters('ImageSku')]"
                  },
                  "ImageVersion": {
                    "value": "[parameters('ImageVersion')]"
                  },
                  "KeyVaultName": {
                    "value": "[parameters('KeyVaultName')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "LogAnalyticsWorkspaceName": {
                    "value": "[parameters('LogAnalyticsWorkspaceName')]"
                  },
                  "Monitoring": {
                    "value": "[parameters('Monitoring')]"
                  },
                  "NamingStandard": {
                    "value": "[parameters('NamingStandard')]"
                  },
                  "NetworkSecurityGroupName": {
                    "value": "[parameters('NetworkSecurityGroupName')]"
                  },
                  "NetAppFileShare": {
                    "value": "[parameters('NetAppFileShare')]"
                  },
                  "OuPath": {
                    "value": "[parameters('OuPath')]"
                  },
                  "RdpShortPath": {
                    "value": "[parameters('RdpShortPath')]"
                  },
                  "ResourceGroups": {
                    "value": "[parameters('ResourceGroups')]"
                  },
                  "ScreenCaptureProtection": {
                    "value": "[parameters('ScreenCaptureProtection')]"
                  },
                  "SasToken": {
                    "value": "[parameters('SasToken')]"
                  },
                  "ScriptsUri": {
                    "value": "[parameters('ScriptsUri')]"
                  },
                  "SessionHostCount": {
                    "value": "[if(and(equals(range(1, parameters('SessionHostBatchCount'))[copyIndex()], parameters('SessionHostBatchCount')), greater(parameters('DivisionRemainderValue'), 0)), parameters('DivisionRemainderValue'), parameters('MaxResourcesPerTemplateDeployment'))]"
                  },
                  "SessionHostIndex": {
                    "value": "[if(equals(range(1, parameters('SessionHostBatchCount'))[copyIndex()], 1), parameters('SessionHostIndex'), add(mul(sub(range(1, parameters('SessionHostBatchCount'))[copyIndex()], 1), parameters('MaxResourcesPerTemplateDeployment')), parameters('SessionHostIndex')))]"
                  },
                  "StorageAccountPrefix": {
                    "value": "[parameters('StorageAccountPrefix')]"
                  },
                  "StorageCount": {
                    "value": "[parameters('StorageCount')]"
                  },
                  "StorageIndex": {
                    "value": "[parameters('StorageIndex')]"
                  },
                  "StorageSolution": {
                    "value": "[parameters('StorageSolution')]"
                  },
                  "StorageSuffix": {
                    "value": "[parameters('StorageSuffix')]"
                  },
                  "Subnet": {
                    "value": "[parameters('Subnet')]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "VirtualNetwork": {
                    "value": "[parameters('VirtualNetwork')]"
                  },
                  "VirtualNetworkResourceGroup": {
                    "value": "[parameters('VirtualNetworkResourceGroup')]"
                  },
                  "VmName": {
                    "value": "[parameters('VmName')]"
                  },
                  "VmPassword": {
                    "value": "[parameters('VmPassword')]"
                  },
                  "VmSize": {
                    "value": "[parameters('VmSize')]"
                  },
                  "VmUsername": {
                    "value": "[parameters('VmUsername')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.18.56646",
                      "templateHash": "9199788853849717624"
                    }
                  },
                  "parameters": {
                    "AcceleratedNetworking": {
                      "type": "string"
                    },
                    "AvailabilitySetPrefix": {
                      "type": "string"
                    },
                    "AutomationAccountName": {
                      "type": "string"
                    },
                    "Availability": {
                      "type": "string"
                    },
                    "ConfigurationName": {
                      "type": "string"
                    },
                    "DisaStigCompliance": {
                      "type": "bool"
                    },
                    "DiskEncryption": {
                      "type": "bool"
                    },
                    "DiskSku": {
                      "type": "string"
                    },
                    "DomainJoinPassword": {
                      "type": "secureString"
                    },
                    "DomainJoinUserPrincipalName": {
                      "type": "string"
                    },
                    "DomainName": {
                      "type": "string"
                    },
                    "DomainServices": {
                      "type": "string"
                    },
                    "EphemeralOsDisk": {
                      "type": "string"
                    },
                    "FileShares": {
                      "type": "array"
                    },
                    "Fslogix": {
                      "type": "bool"
                    },
                    "HostPoolName": {
                      "type": "string"
                    },
                    "HostPoolType": {
                      "type": "string"
                    },
                    "ImageOffer": {
                      "type": "string"
                    },
                    "ImagePublisher": {
                      "type": "string"
                    },
                    "ImageSku": {
                      "type": "string"
                    },
                    "ImageVersion": {
                      "type": "string"
                    },
                    "KeyVaultName": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "LogAnalyticsWorkspaceName": {
                      "type": "string"
                    },
                    "Monitoring": {
                      "type": "bool"
                    },
                    "NamingStandard": {
                      "type": "string"
                    },
                    "NetworkSecurityGroupName": {
                      "type": "string"
                    },
                    "NetAppFileShare": {
                      "type": "string"
                    },
                    "OuPath": {
                      "type": "string"
                    },
                    "RdpShortPath": {
                      "type": "bool"
                    },
                    "ResourceGroups": {
                      "type": "array"
                    },
                    "ScreenCaptureProtection": {
                      "type": "bool"
                    },
                    "SasToken": {
                      "type": "string"
                    },
                    "ScriptsUri": {
                      "type": "string"
                    },
                    "SessionHostCount": {
                      "type": "int"
                    },
                    "SessionHostIndex": {
                      "type": "int"
                    },
                    "StorageAccountPrefix": {
                      "type": "string"
                    },
                    "StorageCount": {
                      "type": "int"
                    },
                    "StorageIndex": {
                      "type": "int"
                    },
                    "StorageSolution": {
                      "type": "string"
                    },
                    "StorageSuffix": {
                      "type": "string"
                    },
                    "Subnet": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentity": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "VirtualNetwork": {
                      "type": "string"
                    },
                    "VirtualNetworkResourceGroup": {
                      "type": "string"
                    },
                    "VmName": {
                      "type": "string"
                    },
                    "VmPassword": {
                      "type": "secureString"
                    },
                    "VmSize": {
                      "type": "string"
                    },
                    "VmUsername": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "AmdVmSizes": [
                      "Standard_NV4as_v4",
                      "Standard_NV8as_v4",
                      "Standard_NV16as_v4",
                      "Standard_NV32as_v4"
                    ],
                    "AmdVmSize": "[contains(variables('AmdVmSizes'), parameters('VmSize'))]",
                    "DeploymentResourceGroup": "[parameters('ResourceGroups')[0]]",
                    "Intune": "[if(equals(parameters('DomainServices'), 'NoneWithIntune'), true(), false())]",
                    "NvidiaVmSizes": [
                      "Standard_NV6",
                      "Standard_NV12",
                      "Standard_NV24",
                      "Standard_NV12s_v3",
                      "Standard_NV24s_v3",
                      "Standard_NV48s_v3",
                      "Standard_NC4as_T4_v3",
                      "Standard_NC8as_T4_v3",
                      "Standard_NC16as_T4_v3",
                      "Standard_NC64as_T4_v3"
                    ],
                    "NvidiaVmSize": "[contains(variables('NvidiaVmSizes'), parameters('VmSize'))]",
                    "PooledHostPool": "[equals(split(parameters('HostPoolType'), ' ')[0], 'Pooled')]",
                    "EphemeralOsDisk_var": {
                      "osType": "Windows",
                      "createOption": "FromImage",
                      "caching": "ReadOnly",
                      "diffDiskSettings": {
                        "option": "Local",
                        "placement": "[parameters('EphemeralOsDisk')]"
                      }
                    },
                    "ManagementResourceGroup": "[parameters('ResourceGroups')[2]]",
                    "StatefulOsDisk": {
                      "osType": "Windows",
                      "createOption": "FromImage",
                      "caching": "None",
                      "managedDisk": {
                        "storageAccountType": "[parameters('DiskSku')]"
                      }
                    },
                    "VmIdentityType": "[if(contains(parameters('DomainServices'), 'None'), if(not(empty(parameters('UserAssignedIdentity'))), 'SystemAssigned, UserAssigned', 'SystemAssigned'), if(not(empty(parameters('UserAssignedIdentity'))), 'UserAssigned', 'None'))]",
                    "VmIdentityTypeProperty": {
                      "type": "[variables('VmIdentityType')]"
                    },
                    "VmUserAssignedIdentityProperty": {
                      "userAssignedIdentities": {
                        "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities/', parameters('UserAssignedIdentity')))]": {}
                      }
                    },
                    "VmIdentity": "[if(not(empty(parameters('UserAssignedIdentity'))), union(variables('VmIdentityTypeProperty'), variables('VmUserAssignedIdentityProperty')), variables('VmIdentityTypeProperty'))]"
                  },
                  "resources": [
                    {
                      "condition": "[parameters('RdpShortPath')]",
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-03-01",
                      "name": "[parameters('NetworkSecurityGroupName')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "securityRules": [
                          {
                            "name": "AllowRdpShortPath",
                            "properties": {
                              "access": "Allow",
                              "destinationAddressPrefix": "*",
                              "destinationPortRange": "3390",
                              "direction": "Inbound",
                              "priority": 3390,
                              "protocol": "Udp",
                              "sourceAddressPrefix": "VirtualNetwork",
                              "sourcePortRange": "*"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "copy": {
                        "name": "networkInterface",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2020-05-01",
                      "name": "[format('nic-{0}-{1}', parameters('NamingStandard'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[resourceId(subscription().subscriptionId, parameters('VirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('VirtualNetwork'), parameters('Subnet'))]"
                              },
                              "primary": true,
                              "privateIPAddressVersion": "IPv4"
                            }
                          }
                        ],
                        "enableAcceleratedNetworking": "[if(equals(parameters('AcceleratedNetworking'), 'True'), true(), false())]",
                        "enableIPForwarding": false,
                        "networkSecurityGroup": "[if(parameters('RdpShortPath'), createObject('id', resourceId('Microsoft.Network/networkSecurityGroups', parameters('NetworkSecurityGroupName'))), null())]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('NetworkSecurityGroupName'))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "virtualMachine",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "zones": "[if(equals(parameters('Availability'), 'AvailabilityZones'), createArray(string(add(mod(range(0, parameters('SessionHostCount'))[copyIndex()], 3), 1))), null())]",
                      "identity": "[variables('VmIdentity')]",
                      "properties": {
                        "availabilitySet": "[if(equals(parameters('Availability'), 'AvailabilitySet'), createObject('id', resourceId('Microsoft.Compute/availabilitySets', format('{0}{1}', parameters('AvailabilitySetPrefix'), div(range(0, parameters('SessionHostCount'))[copyIndex()], 200)))), null())]",
                        "hardwareProfile": {
                          "vmSize": "[parameters('VmSize')]"
                        },
                        "storageProfile": {
                          "imageReference": {
                            "publisher": "[parameters('ImagePublisher')]",
                            "offer": "[parameters('ImageOffer')]",
                            "sku": "[parameters('ImageSku')]",
                            "version": "[parameters('ImageVersion')]"
                          },
                          "osDisk": "[if(equals(parameters('EphemeralOsDisk'), 'None'), variables('StatefulOsDisk'), variables('EphemeralOsDisk_var'))]",
                          "dataDisks": []
                        },
                        "osProfile": {
                          "computerName": "[format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'))]",
                          "adminUsername": "[parameters('VmUsername')]",
                          "adminPassword": "[parameters('VmPassword')]",
                          "windowsConfiguration": {
                            "provisionVMAgent": true,
                            "enableAutomaticUpdates": false
                          },
                          "secrets": [],
                          "allowExtensionOperations": true
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}-{1}', parameters('NamingStandard'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0')))]"
                            }
                          ]
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": false
                          }
                        },
                        "licenseType": "[if(equals(parameters('ImagePublisher'), 'MicrosoftWindowsServer'), 'Windows_Server', 'Windows_Client')]"
                      },
                      "dependsOn": [
                        "networkInterface"
                      ]
                    },
                    {
                      "condition": "[parameters('Monitoring')]",
                      "copy": {
                        "name": "extension_MicrosoftMonitoringAgent",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}{1}/MicrosoftMonitoringAgent', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                        "type": "MicrosoftMonitoringAgent",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "workspaceId": "[reference(resourceId(variables('ManagementResourceGroup'), parameters('LogAnalyticsWorkspaceName')), '2015-03-20').customerId]"
                        },
                        "protectedSettings": {
                          "workspaceKey": "[listKeys(resourceId(variables('ManagementResourceGroup'), parameters('LogAnalyticsWorkspaceName')), '2015-03-20').primarySharedKey]"
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "extension_CustomScriptExtension",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}{1}/CustomScriptExtension', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "CustomScriptExtension",
                        "typeHandlerVersion": "1.10",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "fileUris": [
                            "[format('{0}Set-SessionHostConfiguration.ps1{1}', parameters('ScriptsUri'), parameters('SasToken'))]"
                          ],
                          "timestamp": "[parameters('Timestamp')]"
                        },
                        "protectedSettings": {
                          "commandToExecute": "[format('powershell -ExecutionPolicy Unrestricted -File Set-SessionHostConfiguration.ps1 -AmdVmSize {0} -DisaStigCompliance {1} -DomainName {2} -Environment {3} -FileShares {4} -FSLogix {5} -HostPoolName {6} -HostPoolRegistrationToken {7} -ImageOffer {8} -ImagePublisher {9} -NetAppFileShare {10} -NvidiaVmSize {11} -PooledHostPool {12} -RdpShortPath {13} -ScreenCaptureProtection {14} -StorageAccountPrefix {15} -StorageCount {16} -StorageIndex {17} -StorageSolution {18} -StorageSuffix {19}', variables('AmdVmSize'), parameters('DisaStigCompliance'), parameters('DomainName'), environment().name, parameters('FileShares'), parameters('Fslogix'), parameters('HostPoolName'), reference(resourceId(variables('ManagementResourceGroup'), 'Microsoft.DesktopVirtualization/hostpools', parameters('HostPoolName')), '2019-12-10-preview').registrationInfo.token, parameters('ImageOffer'), parameters('ImagePublisher'), parameters('NetAppFileShare'), variables('NvidiaVmSize'), variables('PooledHostPool'), parameters('RdpShortPath'), parameters('ScreenCaptureProtection'), parameters('StorageAccountPrefix'), parameters('StorageCount'), parameters('StorageIndex'), parameters('StorageSolution'), parameters('StorageSuffix'))]"
                        }
                      },
                      "dependsOn": [
                        "virtualMachine"
                      ]
                    },
                    {
                      "condition": "[contains(parameters('DomainServices'), 'ActiveDirectory')]",
                      "copy": {
                        "name": "extension_JsonADDomainExtension",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}{1}/JsonADDomainExtension', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "publisher": "Microsoft.Compute",
                        "type": "JsonADDomainExtension",
                        "typeHandlerVersion": "1.3",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "Name": "[parameters('DomainName')]",
                          "User": "[parameters('DomainJoinUserPrincipalName')]",
                          "Restart": "true",
                          "Options": "3",
                          "OUPath": "[parameters('OuPath')]"
                        },
                        "protectedSettings": {
                          "Password": "[parameters('DomainJoinPassword')]"
                        }
                      },
                      "dependsOn": [
                        "extension_CustomScriptExtension",
                        "virtualMachine"
                      ]
                    },
                    {
                      "condition": "[contains(parameters('DomainServices'), 'None')]",
                      "copy": {
                        "name": "extension_AADLoginForWindows",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}{1}/AADLoginForWindows', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.ActiveDirectory",
                        "type": "AADLoginForWindows",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "settings": "[if(variables('Intune'), createObject('mdmId', '0000000a-0000-0000-c000-000000000000'), json('null'))]"
                      },
                      "dependsOn": [
                        "extension_CustomScriptExtension",
                        "virtualMachine"
                      ]
                    },
                    {
                      "condition": "[variables('AmdVmSize')]",
                      "copy": {
                        "name": "extension_AmdGpuDriverWindows",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}{1}/AmdGpuDriverWindows', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "publisher": "Microsoft.HpcCompute",
                        "type": "AmdGpuDriverWindows",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "settings": {}
                      },
                      "dependsOn": [
                        "extension_AADLoginForWindows",
                        "extension_JsonADDomainExtension",
                        "virtualMachine"
                      ]
                    },
                    {
                      "condition": "[variables('NvidiaVmSize')]",
                      "copy": {
                        "name": "extension_NvidiaGpuDriverWindows",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}{1}/NvidiaGpuDriverWindows', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "publisher": "Microsoft.HpcCompute",
                        "type": "NvidiaGpuDriverWindows",
                        "typeHandlerVersion": "1.2",
                        "autoUpgradeMinorVersion": true,
                        "settings": {}
                      },
                      "dependsOn": [
                        "extension_AADLoginForWindows",
                        "extension_JsonADDomainExtension",
                        "virtualMachine"
                      ]
                    },
                    {
                      "condition": "[parameters('DiskEncryption')]",
                      "copy": {
                        "name": "extension_AzureDiskEncryption",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2017-03-30",
                      "name": "[format('{0}{1}/AzureDiskEncryption', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Security",
                        "type": "AzureDiskEncryption",
                        "typeHandlerVersion": "2.2",
                        "autoUpgradeMinorVersion": true,
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "settings": {
                          "EncryptionOperation": "EnableEncryption",
                          "KeyVaultURL": "[reference(resourceId(variables('ManagementResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('KeyVaultName')), '2016-10-01', 'Full').properties.vaultUri]",
                          "KeyVaultResourceId": "[resourceId(variables('ManagementResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('KeyVaultName'))]",
                          "KeyEncryptionKeyURL": "[reference(resourceId(variables('DeploymentResourceGroup'), 'Microsoft.Resources/deploymentScripts', format('ds-{0}-bitlockerKek', parameters('NamingStandard'))), '2019-10-01-preview', 'Full').properties.outputs.text]",
                          "KekVaultResourceId": "[resourceId(variables('ManagementResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('KeyVaultName'))]",
                          "KeyEncryptionAlgorithm": "RSA-OAEP",
                          "VolumeType": "All",
                          "ResizeOSDisk": false
                        }
                      },
                      "dependsOn": [
                        "extension_AmdGpuDriverWindows",
                        "extension_NvidiaGpuDriverWindows"
                      ]
                    },
                    {
                      "condition": "[parameters('DisaStigCompliance')]",
                      "copy": {
                        "name": "extension_DSC",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2019-07-01",
                      "name": "[format('{0}{1}/DSC', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "publisher": "Microsoft.Powershell",
                        "type": "DSC",
                        "typeHandlerVersion": "2.77",
                        "autoUpgradeMinorVersion": true,
                        "protectedSettings": {
                          "Items": {
                            "registrationKeyPrivate": "[listKeys(resourceId(variables('ManagementResourceGroup'), 'Microsoft.Automation/automationAccounts', parameters('AutomationAccountName')), '2018-06-30').Keys[0].value]"
                          }
                        },
                        "settings": {
                          "Properties": [
                            {
                              "Name": "RegistrationKey",
                              "Value": {
                                "UserName": "PLACEHOLDER_DONOTUSE",
                                "Password": "PrivateSettingsRef:registrationKeyPrivate"
                              },
                              "TypeName": "System.Management.Automation.PSCredential"
                            },
                            {
                              "Name": "RegistrationUrl",
                              "Value": "[reference(resourceId(variables('ManagementResourceGroup'), 'Microsoft.Automation/automationAccounts', parameters('AutomationAccountName')), '2018-06-30').registrationUrl]",
                              "TypeName": "System.String"
                            },
                            {
                              "Name": "NodeConfigurationName",
                              "Value": "[format('{0}.localhost', parameters('ConfigurationName'))]",
                              "TypeName": "System.String"
                            },
                            {
                              "Name": "ConfigurationMode",
                              "Value": "ApplyandAutoCorrect",
                              "TypeName": "System.String"
                            },
                            {
                              "Name": "RebootNodeIfNeeded",
                              "Value": true,
                              "TypeName": "System.Boolean"
                            },
                            {
                              "Name": "ActionAfterReboot",
                              "Value": "ContinueConfiguration",
                              "TypeName": "System.String"
                            },
                            {
                              "Name": "Timestamp",
                              "Value": "[parameters('Timestamp')]",
                              "TypeName": "System.String"
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "extension_AzureDiskEncryption"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroups')[1]), 'Microsoft.Resources/deployments', format('AvailabilitySets_{0}', parameters('Timestamp')))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[2]), 'Microsoft.Resources/deployments', format('BitLocker_{0}', parameters('Timestamp')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('FSLogix_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[2]), 'Microsoft.Resources/deployments', format('Monitoring_{0}', parameters('Timestamp')))]",
        "resourceGroups",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[2]), 'Microsoft.Resources/deployments', format('STIG_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[0]), 'Microsoft.Resources/deployments', format('Validation_{0}', parameters('Timestamp')))]"
      ]
    },
    {
      "condition": "[parameters('RecoveryServices')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('Backup_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroups')[2]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "DivisionRemainderValue": {
            "value": "[variables('DivisionRemainderValue')]"
          },
          "HostPoolName": {
            "value": "[variables('HostPoolName')]"
          },
          "HostPoolType": {
            "value": "[parameters('HostPoolType')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "MaxResourcesPerTemplateDeployment": {
            "value": "[variables('MaxResourcesPerTemplateDeployment')]"
          },
          "RecoveryServicesVaultName": {
            "value": "[variables('RecoveryServicesVaultName')]"
          },
          "SessionHostBatchCount": {
            "value": "[variables('SessionHostBatchCount')]"
          },
          "SessionHostIndex": {
            "value": "[parameters('SessionHostIndex')]"
          },
          "StorageAccountName": {
            "value": "[variables('StorageAccountPrefix')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "TimeZone": {
            "value": "[variables('TimeZones')[parameters('Location')]]"
          },
          "VmName": {
            "value": "[variables('VmName')]"
          },
          "VmResourceGroupName": {
            "value": "[variables('ResourceGroups')[1]]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "745315380795447522"
            }
          },
          "parameters": {
            "DivisionRemainderValue": {
              "type": "int"
            },
            "HostPoolName": {
              "type": "string"
            },
            "HostPoolType": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "MaxResourcesPerTemplateDeployment": {
              "type": "int"
            },
            "RecoveryServicesVaultName": {
              "type": "string"
            },
            "SessionHostBatchCount": {
              "type": "int"
            },
            "SessionHostIndex": {
              "type": "int"
            },
            "StorageAccountName": {
              "type": "string"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            },
            "TimeZone": {
              "type": "string"
            },
            "VmName": {
              "type": "string"
            },
            "VmResourceGroupName": {
              "type": "string"
            }
          },
          "variables": {
            "ResourceGroupName": "[resourceGroup().name]",
            "FileShareBackupContainer": "[format('storagecontainer;Storage;{0};{1}', variables('ResourceGroupName'), parameters('StorageAccountName'))]",
            "PooledHostPool": "[equals(split(parameters('HostPoolType'), ' ')[0], 'Pooled')]",
            "BackupSchedulePolicy": {
              "scheduleRunFrequency": "Daily",
              "scheduleRunTimes": [
                "23:00"
              ],
              "schedulePolicyType": "SimpleSchedulePolicy"
            },
            "BackupRetentionPolicy": {
              "retentionPolicyType": "LongTermRetentionPolicy",
              "dailySchedule": {
                "retentionTimes": [
                  "23:00"
                ],
                "retentionDuration": {
                  "count": 30,
                  "durationType": "Days"
                }
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.RecoveryServices/vaults",
              "apiVersion": "2016-06-01",
              "name": "[parameters('RecoveryServicesVaultName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "sku": {
                "name": "RS0"
              },
              "properties": {}
            },
            {
              "condition": "[variables('PooledHostPool')]",
              "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
              "apiVersion": "2021-08-01",
              "name": "[format('{0}/{1}', parameters('RecoveryServicesVaultName'), 'AvdPolicyStorage')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "backupManagementType": "AzureStorage",
                "schedulePolicy": "[variables('BackupSchedulePolicy')]",
                "retentionPolicy": "[variables('BackupRetentionPolicy')]",
                "timeZone": "[parameters('TimeZone')]",
                "workLoadType": "AzureFileShare"
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('RecoveryServicesVaultName'))]"
              ]
            },
            {
              "condition": "[not(variables('PooledHostPool'))]",
              "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
              "apiVersion": "2021-08-01",
              "name": "[format('{0}/{1}', parameters('RecoveryServicesVaultName'), 'AvdPolicyVm')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "backupManagementType": "AzureIaasVM",
                "schedulePolicy": "[variables('BackupSchedulePolicy')]",
                "retentionPolicy": "[variables('BackupRetentionPolicy')]",
                "timeZone": "[parameters('TimeZone')]",
                "instantRpRetentionRangeInDays": 2
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('RecoveryServicesVaultName'))]"
              ]
            },
            {
              "condition": "[variables('PooledHostPool')]",
              "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers",
              "apiVersion": "2016-12-01",
              "name": "[format('{0}/Azure/{1}', parameters('RecoveryServicesVaultName'), variables('FileShareBackupContainer'))]",
              "properties": {
                "backupManagementType": "AzureStorage",
                "containerType": "StorageContainer",
                "sourceResourceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('StorageAccountName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('RecoveryServicesVaultName'), 'AvdPolicyStorage')]",
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('RecoveryServicesVaultName'))]"
              ]
            },
            {
              "condition": "[variables('PooledHostPool')]",
              "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems",
              "apiVersion": "2021-08-01",
              "name": "[format('{0}/{1}/{2}/{3}', split(format('{0}/Azure/{1}', parameters('RecoveryServicesVaultName'), variables('FileShareBackupContainer')), '/')[0], split(format('{0}/Azure/{1}', parameters('RecoveryServicesVaultName'), variables('FileShareBackupContainer')), '/')[1], split(format('{0}/Azure/{1}', parameters('RecoveryServicesVaultName'), variables('FileShareBackupContainer')), '/')[2], format('AzureFileShare;{0}', toLower(parameters('HostPoolName'))))]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "protectedItemType": "AzureFileShareProtectedItem",
                "policyId": "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('RecoveryServicesVaultName'), 'AvdPolicyStorage')]",
                "sourceResourceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('StorageAccountName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('RecoveryServicesVaultName'), 'AvdPolicyStorage')]",
                "[resourceId('Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers', split(format('{0}/Azure/{1}', parameters('RecoveryServicesVaultName'), variables('FileShareBackupContainer')), '/')[0], split(format('{0}/Azure/{1}', parameters('RecoveryServicesVaultName'), variables('FileShareBackupContainer')), '/')[1], split(format('{0}/Azure/{1}', parameters('RecoveryServicesVaultName'), variables('FileShareBackupContainer')), '/')[2])]"
              ]
            },
            {
              "condition": "[not(variables('PooledHostPool'))]",
              "copy": {
                "name": "protectedItems_Vm",
                "count": "[length(range(1, parameters('SessionHostBatchCount')))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('BackupProtectedItems_VirtualMachines_{0}_{1}', sub(range(1, parameters('SessionHostBatchCount'))[copyIndex()], 1), parameters('Timestamp'))]",
              "resourceGroup": "[resourceGroup().name]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "PolicyId": {
                    "value": "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('RecoveryServicesVaultName'), 'AvdPolicyVm')]"
                  },
                  "RecoveryServicesVaultName": {
                    "value": "[parameters('RecoveryServicesVaultName')]"
                  },
                  "SessionHostCount": {
                    "value": "[if(and(equals(range(1, parameters('SessionHostBatchCount'))[copyIndex()], parameters('SessionHostBatchCount')), greater(parameters('DivisionRemainderValue'), 0)), parameters('DivisionRemainderValue'), parameters('MaxResourcesPerTemplateDeployment'))]"
                  },
                  "SessionHostIndex": {
                    "value": "[if(equals(range(1, parameters('SessionHostBatchCount'))[copyIndex()], 1), parameters('SessionHostIndex'), add(mul(sub(range(1, parameters('SessionHostBatchCount'))[copyIndex()], 1), parameters('MaxResourcesPerTemplateDeployment')), parameters('SessionHostIndex')))]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  },
                  "VmName": {
                    "value": "[parameters('VmName')]"
                  },
                  "VmResourceGroupName": {
                    "value": "[parameters('VmResourceGroupName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.18.56646",
                      "templateHash": "18375057239687615318"
                    }
                  },
                  "parameters": {
                    "Location": {
                      "type": "string"
                    },
                    "PolicyId": {
                      "type": "string"
                    },
                    "RecoveryServicesVaultName": {
                      "type": "string"
                    },
                    "SessionHostCount": {
                      "type": "int"
                    },
                    "SessionHostIndex": {
                      "type": "int"
                    },
                    "Tags": {
                      "type": "object"
                    },
                    "VmName": {
                      "type": "string"
                    },
                    "VmResourceGroupName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "v2VmContainer": "iaasvmcontainer;iaasvmcontainerv2;",
                    "v2Vm": "vm;iaasvmcontainerv2;"
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "protectedItems_Vm",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems",
                      "apiVersion": "2021-08-01",
                      "name": "[format('{0}/Azure/{1}{2};{3}{4}/{5}{6};{7}{8}', parameters('RecoveryServicesVaultName'), variables('v2VmContainer'), parameters('VmResourceGroupName'), parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'), variables('v2Vm'), parameters('VmResourceGroupName'), parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "protectedItemType": "Microsoft.Compute/virtualMachines",
                        "policyId": "[parameters('PolicyId')]",
                        "sourceResourceId": "[resourceId(parameters('VmResourceGroupName'), 'Microsoft.Compute/virtualMachines', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 3, '0')))]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('RecoveryServicesVaultName'), 'AvdPolicyVm')]",
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('RecoveryServicesVaultName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('FSLogix_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[1]), 'Microsoft.Resources/deployments', format('SessionHosts_{0}', parameters('Timestamp')))]"
      ]
    },
    {
      "condition": "[variables('PooledHostPool')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('Scale_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroups')[2]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AutomationAccountName": {
            "value": "[variables('AutomationAccountName')]"
          },
          "BeginPeakTime": {
            "value": "[parameters('ScalingBeginPeakTime')]"
          },
          "EndPeakTime": {
            "value": "[parameters('ScalingEndPeakTime')]"
          },
          "FslogixStorage": {
            "value": "[parameters('FslogixStorage')]"
          },
          "HostPoolName": {
            "value": "[variables('HostPoolName')]"
          },
          "HostPoolResourceGroupName": {
            "value": "[variables('ResourceGroups')[2]]"
          },
          "LimitSecondsToForceLogOffUser": {
            "value": "[parameters('ScalingLimitSecondsToForceLogOffUser')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "LogicAppPrefix": {
            "value": "[variables('LogicAppPrefix')]"
          },
          "MinimumNumberOfRdsh": {
            "value": "[parameters('ScalingMinimumNumberOfRdsh')]"
          },
          "SasToken": {
            "value": "[parameters('SasToken')]"
          },
          "ScriptsUri": {
            "value": "[variables('ScriptsUri')]"
          },
          "SessionHostsResourceGroupName": {
            "value": "[variables('ResourceGroups')[1]]"
          },
          "SessionThresholdPerCPU": {
            "value": "[parameters('ScalingSessionThresholdPerCPU')]"
          },
          "StorageAccountPrefix": {
            "value": "[variables('StorageAccountPrefix')]"
          },
          "StorageResourceGroupName": {
            "value": "[variables('ResourceGroups')[3]]"
          },
          "StorageCount": {
            "value": "[parameters('StorageCount')]"
          },
          "StorageIndex": {
            "value": "[parameters('StorageIndex')]"
          },
          "TimeDifference": {
            "value": "[parameters('ScalingTimeDifference')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "1714390896679289267"
            }
          },
          "parameters": {
            "AutomationAccountName": {
              "type": "string"
            },
            "BeginPeakTime": {
              "type": "string"
            },
            "EndPeakTime": {
              "type": "string"
            },
            "FslogixStorage": {
              "type": "string"
            },
            "HostPoolName": {
              "type": "string"
            },
            "HostPoolResourceGroupName": {
              "type": "string"
            },
            "LimitSecondsToForceLogOffUser": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "LogicAppPrefix": {
              "type": "string"
            },
            "MinimumNumberOfRdsh": {
              "type": "string"
            },
            "SasToken": {
              "type": "secureString"
            },
            "ScriptsUri": {
              "type": "string"
            },
            "SessionHostsResourceGroupName": {
              "type": "string"
            },
            "SessionThresholdPerCPU": {
              "type": "string"
            },
            "StorageAccountPrefix": {
              "type": "string"
            },
            "StorageCount": {
              "type": "int"
            },
            "StorageIndex": {
              "type": "int"
            },
            "StorageResourceGroupName": {
              "type": "string"
            },
            "TimeDifference": {
              "type": "string"
            },
            "Timestamp": {
              "type": "string",
              "defaultValue": "[utcNow('u')]",
              "metadata": {
                "description": "ISO 8601 timestamp used to determine the webhook expiration date.  The webhook is hardcoded to expire 5 years after the timestamp."
              }
            }
          },
          "variables": {
            "Environment": "[environment().name]",
            "ManagementResourceGroupName": "[resourceGroup().name]",
            "RoleAssignmentResourceGroups": "[if(contains(parameters('FslogixStorage'), 'AzureStorageAccount Premium'), concat(variables('ScalingResourceGroups'), variables('StorageResourceGroup')), variables('ScalingResourceGroups'))]",
            "Runbooks": "[if(contains(parameters('FslogixStorage'), 'AzureStorageAccount Premium'), concat(variables('ScalingRunbook'), variables('StorageRunbook')), variables('ScalingRunbook'))]",
            "ScalingResourceGroups": [
              "[variables('ManagementResourceGroupName')]",
              "[parameters('SessionHostsResourceGroupName')]"
            ],
            "ScalingRunbook": [
              {
                "name": "AvdScaleHostPool",
                "script": "Set-HostPoolScaling.ps1"
              }
            ],
            "StorageResourceGroup": [
              "[parameters('StorageResourceGroupName')]"
            ],
            "StorageRunbook": [
              {
                "name": "AvdScaleFileShareQuota",
                "script": "Set-FileShareScaling.ps1"
              }
            ],
            "SubscriptionId": "[subscription().subscriptionId]"
          },
          "resources": [
            {
              "copy": {
                "name": "runbooks",
                "count": "[length(range(0, length(variables('Runbooks'))))]"
              },
              "type": "Microsoft.Automation/automationAccounts/runbooks",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[copyIndex()]].name)]",
              "location": "[parameters('Location')]",
              "properties": {
                "runbookType": "PowerShell",
                "logProgress": false,
                "logVerbose": false,
                "publishContentLink": {
                  "uri": "[format('{0}{1}{2}', parameters('ScriptsUri'), variables('Runbooks')[range(0, length(variables('Runbooks')))[copyIndex()]].script, parameters('SasToken'))]",
                  "version": "1.0.0.0"
                }
              }
            },
            {
              "copy": {
                "name": "webhooks",
                "count": "[length(range(0, length(variables('Runbooks'))))]"
              },
              "type": "Microsoft.Automation/automationAccounts/webhooks",
              "apiVersion": "2015-10-31",
              "name": "[format('{0}/{1}_{2}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[copyIndex()]].name, dateTimeAdd(parameters('Timestamp'), 'PT0H', 'yyyyMMddhhmmss'))]",
              "properties": {
                "isEnabled": true,
                "expiryTime": "[dateTimeAdd(parameters('Timestamp'), 'P5Y')]",
                "runbook": {
                  "name": "[variables('Runbooks')[range(0, length(variables('Runbooks')))[copyIndex()]].name]"
                }
              },
              "dependsOn": [
                "runbooks"
              ]
            },
            {
              "copy": {
                "name": "variables",
                "count": "[length(range(0, length(variables('Runbooks'))))]"
              },
              "type": "Microsoft.Automation/automationAccounts/variables",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[copyIndex()]].name)]",
              "properties": {
                "value": "[format('\"{0}\"', reference(resourceId('Microsoft.Automation/automationAccounts/webhooks', split(format('{0}/{1}_{2}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[range(0, length(variables('Runbooks')))[copyIndex()]]].name, dateTimeAdd(parameters('Timestamp'), 'PT0H', 'yyyyMMddhhmmss')), '/')[0], split(format('{0}/{1}_{2}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[range(0, length(variables('Runbooks')))[copyIndex()]]].name, dateTimeAdd(parameters('Timestamp'), 'PT0H', 'yyyyMMddhhmmss')), '/')[1])).uri)]",
                "isEncrypted": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts/webhooks', split(format('{0}/{1}_{2}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[range(0, length(variables('Runbooks')))[copyIndex()]]].name, dateTimeAdd(parameters('Timestamp'), 'PT0H', 'yyyyMMddhhmmss')), '/')[0], split(format('{0}/{1}_{2}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[range(0, length(variables('Runbooks')))[copyIndex()]]].name, dateTimeAdd(parameters('Timestamp'), 'PT0H', 'yyyyMMddhhmmss')), '/')[1])]"
              ]
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2016-06-01",
              "name": "[format('{0}-scalehosts', parameters('LogicAppPrefix'))]",
              "location": "[parameters('Location')]",
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "HTTP": {
                      "type": "Http",
                      "inputs": {
                        "method": "POST",
                        "uri": "[replace(reference(resourceId('Microsoft.Automation/automationAccounts/variables', split(format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[0]].name), '/')[0], split(format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[0]].name), '/')[1])).value, '\"', '')]",
                        "body": {
                          "AADTenantId": "[subscription().tenantId]",
                          "SubscriptionId": "[subscription().subscriptionId]",
                          "EnvironmentName": "[environment().name]",
                          "ResourceGroupName": "[parameters('HostPoolResourceGroupName')]",
                          "HostPoolName": "[parameters('HostPoolName')]",
                          "MaintenanceTagName": "Maintenance",
                          "TimeDifference": "[parameters('TimeDifference')]",
                          "BeginPeakTime": "[parameters('BeginPeakTime')]",
                          "EndPeakTime": "[parameters('EndPeakTime')]",
                          "SessionThresholdPerCPU": "[parameters('SessionThresholdPerCPU')]",
                          "MinimumNumberOfRDSH": "[parameters('MinimumNumberOfRdsh')]",
                          "LimitSecondsToForceLogOffUser": "[parameters('LimitSecondsToForceLogOffUser')]",
                          "LogOffMessageTitle": "Machine is about to shutdown.",
                          "LogOffMessageBody": "Your session will be logged off. Please save and close everything."
                        }
                      }
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "type": "Recurrence",
                      "recurrence": {
                        "frequency": "Minute",
                        "interval": 15
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts/variables', split(format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[0]].name), '/')[0], split(format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[0]].name), '/')[1])]"
              ]
            },
            {
              "condition": "[contains(parameters('FslogixStorage'), 'AzureStorageAccount Premium')]",
              "copy": {
                "name": "logicApp_ScaleFileShares_OfficeContainers",
                "count": "[length(range(parameters('StorageIndex'), parameters('StorageCount')))]"
              },
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2016-06-01",
              "name": "[format('{0}-{1}{2}-officecontainers', parameters('LogicAppPrefix'), parameters('StorageAccountPrefix'), string(range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]))]",
              "location": "[parameters('Location')]",
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "HTTP": {
                      "type": "Http",
                      "inputs": {
                        "method": "POST",
                        "uri": "[replace(reference(resourceId('Microsoft.Automation/automationAccounts/variables', split(format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[1]].name), '/')[0], split(format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[1]].name), '/')[1])).value, '\"', '')]",
                        "body": {
                          "Environment": "[variables('Environment')]",
                          "FileShareName": "officecontainers",
                          "ResourceGroupName": "[parameters('StorageResourceGroupName')]",
                          "StorageAccountName": "[format('{0}{1}', parameters('StorageAccountPrefix'), string(range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]))]",
                          "SubscriptionId": "[variables('SubscriptionId')]"
                        }
                      }
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "type": "Recurrence",
                      "recurrence": {
                        "frequency": "Minute",
                        "interval": 15
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts/variables', split(format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[1]].name), '/')[0], split(format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[1]].name), '/')[1])]"
              ]
            },
            {
              "condition": "[contains(parameters('FslogixStorage'), 'AzureStorageAccount Premium')]",
              "copy": {
                "name": "logicApp_ScaleFileShares_ProfileContainers",
                "count": "[length(range(parameters('StorageIndex'), parameters('StorageCount')))]"
              },
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2016-06-01",
              "name": "[format('{0}-{1}{2}-profilecontainers', parameters('LogicAppPrefix'), parameters('StorageAccountPrefix'), string(range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]))]",
              "location": "[parameters('Location')]",
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "HTTP": {
                      "type": "Http",
                      "inputs": {
                        "method": "POST",
                        "uri": "[replace(reference(resourceId('Microsoft.Automation/automationAccounts/variables', split(format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[1]].name), '/')[0], split(format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[1]].name), '/')[1])).value, '\"', '')]",
                        "body": {
                          "Environment": "[variables('Environment')]",
                          "FileShareName": "profilecontainers",
                          "ResourceGroupName": "[parameters('StorageResourceGroupName')]",
                          "StorageAccountName": "[format('{0}{1}', parameters('StorageAccountPrefix'), string(range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()]))]",
                          "SubscriptionId": "[variables('SubscriptionId')]"
                        }
                      }
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "type": "Recurrence",
                      "recurrence": {
                        "frequency": "Minute",
                        "interval": 15
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts/variables', split(format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[1]].name), '/')[0], split(format('{0}/WebhookURI_{1}', parameters('AutomationAccountName'), variables('Runbooks')[range(0, length(variables('Runbooks')))[1]].name), '/')[1])]"
              ]
            },
            {
              "copy": {
                "name": "roleAssignments",
                "count": "[length(range(0, length(variables('RoleAssignmentResourceGroups'))))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('RoleAssignment_{0}', variables('RoleAssignmentResourceGroups')[range(0, length(variables('RoleAssignmentResourceGroups')))[copyIndex()]])]",
              "resourceGroup": "[variables('RoleAssignmentResourceGroups')[range(0, length(variables('RoleAssignmentResourceGroups')))[copyIndex()]]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "AutomationAccountId": {
                    "value": "[reference(resourceId('Microsoft.Automation/automationAccounts', parameters('AutomationAccountName')), '2021-06-22', 'Full').identity.principalId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.18.56646",
                      "templateHash": "9234773568662019760"
                    }
                  },
                  "parameters": {
                    "AutomationAccountId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2018-09-01-preview",
                      "name": "[guid(resourceGroup().id, 'ScalingContributor')]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                        "principalId": "[parameters('AutomationAccountId')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[2]), 'Microsoft.Resources/deployments', format('AutomationAccount_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[2]), 'Microsoft.Resources/deployments', format('Backup_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[1]), 'Microsoft.Resources/deployments', format('SessionHosts_{0}', parameters('Timestamp')))]"
      ]
    },
    {
      "condition": "[parameters('DrainMode')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('DrainMode_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroups')[0]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "HostPoolName": {
            "value": "[variables('HostPoolName')]"
          },
          "HostPoolResourceGroupName": {
            "value": "[variables('ResourceGroups')[2]]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "ManagedIdentityResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('ManagedIdentity_{0}', parameters('Timestamp')))).outputs.resourceIdentifier.value]"
          },
          "NamingStandard": {
            "value": "[variables('NamingStandard')]"
          },
          "SasToken": {
            "value": "[parameters('SasToken')]"
          },
          "ScriptsUri": {
            "value": "[variables('ScriptsUri')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.18.56646",
              "templateHash": "8515167579020826572"
            }
          },
          "parameters": {
            "HostPoolName": {
              "type": "string"
            },
            "HostPoolResourceGroupName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "ManagedIdentityResourceId": {
              "type": "string"
            },
            "NamingStandard": {
              "type": "string"
            },
            "SasToken": {
              "type": "string"
            },
            "ScriptsUri": {
              "type": "string"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2019-10-01-preview",
              "name": "[format('ds-{0}-drainMode', parameters('NamingStandard'))]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('ManagedIdentityResourceId'))]": {}
                }
              },
              "location": "[parameters('Location')]",
              "kind": "AzurePowerShell",
              "tags": "[parameters('Tags')]",
              "properties": {
                "azPowerShellVersion": "5.4",
                "cleanupPreference": "OnSuccess",
                "arguments": "[format('-ResourceGroup {0} -HostPool {1}', parameters('HostPoolResourceGroupName'), parameters('HostPoolName'))]",
                "primaryScriptUri": "[format('{0}Set-AzureAvdDrainMode.ps1{1}', parameters('ScriptsUri'), parameters('SasToken'))]",
                "forceUpdateTag": "[parameters('Timestamp')]",
                "retentionInterval": "P1D",
                "timeout": "PT30M"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('ManagedIdentity_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroups')[1]), 'Microsoft.Resources/deployments', format('SessionHosts_{0}', parameters('Timestamp')))]"
      ]
    }
  ]
}
